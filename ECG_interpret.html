<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Interpretation Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Define CSS Variables for Light Theme (Day Mode) */
        :root {
            --background-color: #f0f0f0; /* Light gray background */
            --card-background: #ffffff; /* White card background */
            --card-background-light: #ffffff; /* White card background */
            --card-border: #cccccc; /* Light gray border */
            --text-color-primary: #333333; /* Dark gray text */
            --text-color-secondary: #333333; /* Dark gray text */
            --accent-color-blue: #007AFF; /* Bright blue accent */
            --heading-color: #0056b3; /* Darker blue heading */
            --glow-color: #007AFF; /* Blue glow */
            --input-bg: #ffffff; /* White input background */
            --input-border: #cccccc; /* Light gray input border */
            --button-text: white; /* White button text */
            --button-shadow: rgba(0, 0, 0, 0.1); /* Lighter button shadow */
            --checkbox-border: #cccccc; /* Light gray checkbox border */
            --checkbox-selected-bg: #007AFF; /* Blue for selected checkbox */
            --checkbox-selected-border: #0056b3; /* Darker blue border for selected checkbox */
            --checkbox-text-unselected: #333333; /* Dark text for unselected checkbox */
            --flag-color: #c0392b; /* Darker red for flags */
            --flag-bg: #fadedd; /* Light red for flag background */
            --pagination-button-bg: #e0e0e0; /* Light gray pagination button */
            --pagination-button-text: #333333; /* Dark text pagination button */
            --pagination-button-hover-bg: #cccccc; /* Lighter gray pagination button hover */
            --pagination-button-disabled-bg: #f0f0f0; /* Very light gray pagination button disabled */
            --step-indicator-bg: #333333; /* Dark step indicator background */
            --step-indicator-text: white; /* White text step indicator */
            --error-color: red; /* Color for error messages */
            --normal-range-color: green; /* Color for normal range */
            --overall-range-color-normal: black; /* Color for overall range (normal) */
            --overall-range-color-error: red; /* Color for overall range (error) */
            --warning-color: #f39c12; /* Orange/Yellow for warnings */

             /* Specific colors for pagination buttons */
             --pagination-back-bg: #e74c3c; /* Red for Back */
             --pagination-back-hover-bg: #c0392b; /* Darker red for Back hover */
             --pagination-next-bg: #2ecc71; /* Green for Next */
             --pagination-next-hover-bg: #27ae60; /* Darker green for Next hover */

             /* Specific colors for OK Rules */
             --ok-rule-bg: #e8f5e9; /* Light green background */
             --ok-rule-border: #a5d6a7; /* Green border */
             --ok-rule-text: #2e7d32; /* Dark green text */
            --ok-rule-hover-bg: #dcedc8; /* Lighter green on hover */
            --ok-rule-name-color: #1b5e20; /* Even darker green for rule name */
            --ok-rule-reason-color: #388e3c; /* Greenish text for reason */
            --ok-rule-reason-border: #c8e6c9; /* Light border above reason */
        }

        /* Apply light theme styles by default */
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background-color);
            color: var(--text-color-secondary);
            margin: 0;
            padding: 20px;
            transition: background 0.5s ease, color 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 40px;
            padding-bottom: 40px;
            flex-direction: column; /* Stack image container and form vertically */
            align-items: center;
        }

        .form-container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            position: relative;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px; /* Space between items */
        }

        .pagination-controls::before {
            content: "";
            position: absolute;
            left: 70px;
            right: 70px;
            top: 50%;
            height: 2px;
            background-color: var(--card-border); /* Use card border color for line */
            z-index: -1;
            transform: translateY(-50%);
            transition: background-color 0.5s ease;
        }

        .pagination-button {
            color: var(--button-text);
            padding: 10px 25px;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

         .pagination-button.back {
             background-color: var(--pagination-back-bg);
         }
         .pagination-button.back:hover:not(:disabled) {
             background-color: var(--pagination-back-hover-bg);
         }
         .pagination-button.next {
             background-color: var(--pagination-next-bg);
         }
         .pagination-button.next:hover:not(:disabled) {
             background-color: var(--pagination-next-hover-bg);
         }


        .pagination-button:disabled {
            background-color: var(--pagination-button-disabled-bg);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7; /* Dim disabled buttons */
        }

        /* Styles for the new step buttons */
        #stepButtonsContainer {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* Space between step buttons */
            flex-grow: 1; /* Allow container to grow */
            margin: 0 10px; /* Margin to separate from prev/next buttons */
        }

        .step-button {
            padding: 8px 15px;
            border-radius: 9999px; /* Pill shape */
            border: 1px solid var(--card-border);
            background-color: var(--pagination-button-bg);
            color: var(--pagination-button-text);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0; /* Prevent buttons from shrinking too much */
        }

        .step-button:hover {
            background-color: var(--pagination-button-hover-bg);
        }

        .step-button.step-blue {
            background-color: var(--accent-color-blue);
            color: white;
            border-color: var(--accent-color-blue);
        }
        .step-button.step-green {
            background-color: #d4edda; /* Light green */
            color: #155724; /* Dark green text */
            border-color: #28a745; /* Green border */
        }
        .step-button.step-yellow {
            background-color: #fff3cd; /* Light yellow */
            color: #856404; /* Dark yellow text */
            border-color: #ffc107; /* Yellow border */
        }
        .step-button.step-red {
            background-color: #f8d7da; /* Light red */
            color: #721c24; /* Dark red text */
            border-color: #dc3545; /* Red border */
        }
        .step-button.step-white { /* Default for unvisited/no status */
            background-color: white;
            color: var(--text-color-secondary);
            border-color: var(--card-border);
        }

        /* Styles for the step dropdown */
        #stepDropdown {
            width: 200px; /* Adjust width as needed */
            padding: 10px 15px;
            border-radius: 9999px;
            font-size: 0.95rem;
            color: var(--text-color-primary);
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            appearance: none;
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s, background-color 0.5s ease, color 0.5s ease;
            margin-top: 20px; /* Space above dropdown */
            margin-bottom: 20px; /* Space below dropdown */
            align-self: center; /* Center the dropdown */
        }

        #stepDropdown:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 8px rgba(var(--glow-color), 0.5);
        }

        .form-section {
            background-color: var(--card-background); /* Use card background color */
            padding: 35px;
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1); /* Adjusted shadow for depth */
            margin-bottom: 60px;
            border: 1px solid var(--card-border); /* Use card border color */
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }
        .form-section h2 {
            font-size: 1.65rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--heading-color); /* Use heading color */
            text-align: center; /* Center headings */
            text-shadow: 0 0 5px rgba(var(--glow-color), 0.3); /* Subtle text shadow */
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }
        .field-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        .input-label {
            display: block;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color-secondary); /* Use secondary text color */
            font-size: 0.9rem;
            transition: color 0.5s ease;
        }
        .input-field, .select-field, textarea.input-field { /* Added textarea */
            width: 100%;
            padding: 12px 16px;
            border-radius: 9999px;
            font-size: 0.95rem;
            color: var(--text-color-primary); /* Use primary text color */
            background-color: var(--input-bg); /* Use input background color */
            border: 1px solid var(--input-border); /* Use input border color */
            appearance: none;
            position: relative;
            transition: box-shadow 0.2s, border-color 0.2s, background-color 0.5s ease, color 0.5s ease;
        }
         textarea.input-field {
             border-radius: 12px; /* Slightly different border-radius for textarea */
             min-height: 100px; /* Minimum height for textarea */
         }
        .input-field::placeholder {
            color: var(--text-color-secondary); /* Use secondary text color for placeholder */
            opacity: 0.7;
        }
        .input-field:focus, .select-field:focus, textarea.input-field:focus { /* Added textarea */
            outline: none;
            border-color: var(--glow-color); /* Use glow color on focus */
            box-shadow: 0 0 8px rgba(var(--glow-color), 0.5); /* Glow effect on focus */
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: '';
            width: 10px;
            height: 10px;
            border-style: solid;
            border-color: var(--accent-color-blue); /* Use blue accent color for arrow */
            border-width: 0 2.5px 2.5px 0;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-60%) rotate(45deg);
            pointer-events: none;
            transition: transform 0.2s, border-color 0.5s ease;
        }

        .checkbox-group, .radio-group { /* Added radio-group */
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px; /* Adjusted margin */
        }

        .checkbox-label, .radio-label { /* Added radio-label */
            display: inline-flex;
            align-items: center;
            padding: 12px 22px;
            border: 3px solid var(--checkbox-border); /* Use checkbox border color */
            border-radius: 9999px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--checkbox-text-unselected); /* Use unselected text color */
            background-color: white; /* White background for unselected */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .checkbox-label input[type="checkbox"],
        .radio-label input[type="radio"] { /* Added radio input */
            display: none;
        }
        .checkbox-label.selected,
        .radio-label.selected { /* Added radio selected */
            background-color: var(--checkbox-selected-bg); /* Use selected background color */
            color: white;
            border-color: var(--checkbox-selected-border); /* Use selected border color */
        }
        .checkbox-label:hover:not(.selected):not(:has(input:disabled)),
        .radio-label:hover:not(.selected):not(:has(input:disabled)) { /* Added radio hover */
            border-color: var(--checkbox-selected-border); /* Highlight border on hover */
        }

         .radio-label:has(input:disabled),
         .checkbox-label:has(input:disabled) { /* Added checkbox disabled style */
            opacity: 0.6;
            cursor: not-allowed;
            border-color: var(--flag-color) !important; /* Red border when disabled */
            color: var(--flag-color) !important; /* Red text when disabled */
        }


        .flagged {
            border-color: var(--flag-color) !important;
            background-color: var(--flag-bg) !important;
        }
        .flag-message {
            font-size: 0.75rem;
            color: var(--flag-color); /* Use flag color */
            margin-top: 6px;
            padding-left: 5px;
        }
         .range-info {
             font-size: 0.75rem;
             margin-top: 4px;
             padding-left: 5px;
         }
         .normal-range {
             color: var(--normal-range-color);
         }
         .overall-range {
             color: var(--overall-range-color-normal);
         }
         .overall-range.error {
             color: var(--overall-range-color-error);
             font-weight: bold;
         }

        .rule-match {
            color: green;
        }
         .rule-no-match {
            color: red; /* Changed to red for non-matching rules */
            font-weight: bold;
        }
        .conflict-highlight { /* New class for highlighting conflicting fields */
            border-color: red !important;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.5) !important;
        }
        .conflict-message { /* New class for inline conflict messages */
            font-size: 0.75rem;
            color: red;
            margin-top: 6px;
            padding-left: 5px;
        }
        .warning-highlight { /* New class for highlighting warning fields */
            border-color: var(--warning-color) !important;
            box-shadow: 0 0 8px rgba(var(--warning-color), 0.5) !important;
        }
        .warning-message { /* New class for inline warning messages */
            font-size: 0.75rem;
            color: var(--warning-color);
            margin-top: 6px;
            padding-left: 5px;
        }


        /* Styles for the Analysis Button */
         #analyzeBtn, #exportExcelBtn { /* Added exportExcelBtn */
            background: var(--accent-color-blue);
            color: var(--button-text);
            padding: 15px 30px;
            border-radius: 8px; /* Slightly rounded corners */
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            box-shadow: 0 5px 15px var(--button-shadow);
            display: inline-flex; /* Align spinner */
            align-items: center;
            justify-content: center;
            border: none; /* Ensure no default border */
        }

        #analyzeBtn::before, #exportExcelBtn::before { /* Added exportExcelBtn */
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.75s cubic-bezier(0.19, 1, 0.22, 1);
            border-radius: 50%;
            z-index: 0;
            transform: translate(-50%, -50%) scale(0);
        }

        #analyzeBtn:hover::before, #exportExcelBtn:hover::before { /* Added exportExcelBtn */
            transform: translate(-50%, -50%) scale(1);
        }

        #analyzeBtn:hover:not(:disabled), #exportExcelBtn:hover:not(:disabled) { /* Added exportExcelBtn */
            box-shadow: 0 8px 20px var(--button-shadow);
            transform: translateY(-2px);
            background-color: var(--heading-color); /* Darker blue on hover */
        }

         #analyzeBtn:active:not(:disabled), #exportExcelBtn:active:not(:disabled) { /* Added exportExcelBtn */
            transform: translateY(0);
            box-shadow: 0 3px 10px var(--button-shadow);
        }

        #analyzeBtn:disabled, #exportExcelBtn:disabled { /* Added exportExcelBtn */
             background-color: var(--pagination-button-disabled-bg);
             cursor: not-allowed;
             box-shadow: none;
        }

        /* Styles for the message area below the buttons */
        #analysisMessages {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        #analysisMessages ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #analysisMessages li {
            margin-bottom: 5px;
            font-weight: bold;
        }
        #analysisMessages li.error {
            color: var(--error-color);
        }
        #analysisMessages li.warning {
            color: var(--warning-color);
        }


        /* Styles for Analysis Results Sections */
        #analysisResults .form-section {
            background-color: var(--card-background-light); /* Use lighter card background for results */
            border-left: 6px solid var(--accent-color-blue); /* Blue accent border */
            margin-top: 20px; /* Adjust margin */
            padding: 25px; /* Adjust padding */
            border-radius: 24px; /* Match form-section border-radius */
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        #analysisResults .form-section h2 {
             font-size: 1.4rem; /* Smaller heading for results sections */
             margin-bottom: 15px; /* Adjust margin */
             text-align: left; /* Align headings left */
             text-shadow: none; /* Remove text shadow */
             color: var(--text-color-primary); /* Use primary text color */
        }

        #analysisResults p {
            color: var(--text-color-secondary); /* Use secondary text color for text */
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        #analysisResults strong {
             color: var(--text-color-primary); /* Use primary text color for strong text */
        }

        #analysisResults .rule-match, #analysisResults .rule-no-match {
             font-weight: normal; /* Reset font weight */
             color: var(--text-color-secondary); /* Use secondary text color */
        }

         /* Remove default rule check styling */
         #analysisResults .rule-match::after, #analysisResults .rule-no-match::after {
             content: none;
         }

        /* Animation for results section */
        #analysisResults {
             opacity: 0;
             transform: translateY(20px);
             animation: fadeSlideIn 0.8s ease-out forwards;
        }

        @keyframes fadeSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Image container styles */
        .image-container {
            display: flex;
            justify-content: space-between; /* Changed to space-between */
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            padding: 0 20px; /* Added padding to align with form container */
            max-width: 800px; /* Match form container width */
            width: 100%;
        }

        .image-container img {
            max-width: 150px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            /* Ensure images don't grow and maintain size */
            flex-shrink: 0;
        }

        /* Modal Styles - Enhanced */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            padding-top: 60px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--card-border);
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
            animation: modalFadeIn 0.5s ease-out;
            color: var(--text-color-secondary);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: var(--text-color-secondary);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #ff0000;
            text-decoration: none;
        }

        #modalMessage {
            color: var(--text-color-secondary);
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: left; /* Align modal text left */
        }
         #modalMessage strong {
             color: var(--text-color-primary); /* Primary color for bold text in modal */
         }

         .error-list, .not-ok-rules-list { /* Added not-ok-rules-list */
             list-style: disc;
             padding-left: 20px;
             margin-top: 15px;
         }
         .error-list li {
             margin-bottom: 5px;
             color: var(--error-color); /* Red color for error list items */
         }
         .not-ok-rules-list li { /* Style for not ok rules in modal */
             margin-bottom: 5px;
             color: var(--text-color-primary); /* Dark text for list items */
         }

         /* Styles for bottom pagination controls */
         .bottom-pagination-controls {
             display: flex;
             justify-content: center; /* Center buttons */
             gap: 20px; /* Space between buttons */
             margin-top: 20px; /* Space above buttons */
         }

         /* Style for the toggle NOT OK rules button */
         #toggleNotOkRulesBtn {
             background-color: #ff4136; /* Red for Not OK button */
             color: white;
             padding: 10px 20px;
             border-radius: 8px;
             cursor: pointer;
             font-size: 0.9em;
             margin-top: 15px;
             border: none;
             transition: background-color 0.3s ease;
             display: block; /* Make it a block element to center */
             margin-left: auto;
             margin-right: auto;
         }
         #toggleNotOkRulesBtn:hover {
             background-color: #e02b20;
         }

        /* Styles for the OK Rules List (Clickable) */
        #okRulesListContainer {
            margin-top: 20px;
             /* Added styling for the container */
             padding: 15px;
             border: 1px solid var(--ok-rule-border); /* Green border */
             background-color: var(--ok-rule-bg); /* Light green background */
             border-radius: 8px;
             /* display: none; */ /* Removed this, will be handled by JS */
        }

        .ok-rule-item-clickable {
            /* Removed background, border, padding, margin-bottom from here */
            /* These styles are now on the container #okRulesListContainer */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.95rem; /* Adjusted font size */
            color: var(--ok-rule-text); /* Dark green text */
            margin-bottom: 8px; /* Add space between list items */
            padding-bottom: 8px; /* Add padding below list item content */
            border-bottom: 1px solid var(--ok-rule-reason-border); /* Add a separator line */
        }

        .ok-rule-item-clickable:last-child {
            margin-bottom: 0; /* Remove bottom margin for the last item */
            border-bottom: none; /* Remove border for the last item */
        }

        .ok-rule-item-clickable:hover {
            background-color: var(--ok-rule-hover-bg); /* Lighter green on hover */
            transform: translateY(-1px); /* Subtle lift effect */
        }

        .ok-rule-item-clickable:active {
            transform: translateY(0);
        }

        .ok-rule-item-clickable strong {
             color: var(--ok-rule-name-color); /* Even darker green for rule name */
             display: block; /* Ensure rule name is on its own line */
             margin-bottom: 5px; /* Space between name and reason */
        }

        .ok-rule-reason-hidden {
            font-size: 0.85rem; /* Smaller font for reason */
            color: var(--ok-rule-reason-color); /* Greenish text for reason */
            margin-top: 5px;
            padding-top: 5px; /* Add padding above reason */
            /* Removed border-top here, using border-bottom on the item instead */
            display: none; /* Initially hidden */
        }


         /* Styles for NOT OK Rules Section */
         #notOkRulesSection {
             margin-top: 20px;
             padding: 15px;
             border: 1px solid var(--flag-color); /* Red border */
             background-color: var(--flag-bg); /* Light red background */
             border-radius: 8px;
             /* display: none; */ /* Removed this, will be handled by JS */
         }

         #notOkRulesSection h3 {
             color: var(--flag-color); /* Red heading */
             margin-top: 0;
             margin-bottom: 10px;
             font-size: 1.1rem;
         }

         #notOkRulesSection ul {
             list-style: disc;
             padding-left: 20px;
         }

         #notOkRulesSection li {
             margin-bottom: 5px;
             color: var(--text-color-primary); /* Dark text for list items */
         }

        /* Style for the toggle OK rules button */
        #toggleOkRulesBtn {
             background-color: #2ecc71; /* Green for OK button */
             color: white;
             padding: 10px 20px;
             border-radius: 8px;
             cursor: pointer;
             font-size: 0.9em;
             margin-top: 15px; /* Space above button */
             margin-bottom: 15px; /* Space below button */
             border: none;
             transition: background-color 0.3s ease;
             display: block; /* Make it a block element to center */
             margin-left: auto;
             margin-right: auto;
        }
        #toggleOkRulesBtn:hover {
             background-color: #27ae60; /* Darker green on hover */
        }

        /* Styles for the animation canvas */
        .wavy-canvas { /* Changed to class for multiple canvases */
            display: block;
            width: 100%; /* Make it fill the container width */
            height: 150px; /* Fixed height */
            margin-top: 20px; /* Space above the canvas */
            border-radius: 8px; /* Match form section border radius */
            background-color: #f8d8d8; /* Light background color */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            display: none; /* Initially hidden, only shown after analysis */
        }


    </style>
</head>
<body>
    <div class="image-container">
        <img src="Picture1.png" alt="Image 1" onerror="this.onerror=null; this.src='https://placehold.co/150x100/e0e0e0/333333?text=Image+Not+Found';">
        <img src="Picture2.png" alt="Image 2" onerror="this.onerror=null; this.src='https://placehold.co/150x100/e0e0e0/333333?text=Image+Not+Found';">
    </div>

    <div class="form-container">
        <div class="pagination-controls">
            <button id="prevBtn" class="pagination-button back" onclick="changePage(-1)">Previous</button>
            <div id="stepButtonsContainer" class="flex gap-2">
                </div>
            <button id="nextBtn" class="pagination-button next" onclick="changePage(1)">Next</button>
        </div>

        <div class="select-wrapper" style="margin-top: 20px; margin-bottom: 20px; text-align: center;">
            <select id="stepDropdown" class="select-field" onchange="goToPage(parseInt(this.value))">
                </select>
        </div>


        <div class="page" id="page1">
            <div class="form-section">
                <h2>Patient Information</h2>
                <div class="field-group">
                    <div>
                        <label for="patientId" class="input-label">Patient ID</label>
                        <input type="text" id="patientId" class="input-field" placeholder="e.g. P12345">
                    </div>
                    <div>
                        <label for="age" class="input-label">Age</label>
                        <input type="number" id="age" class="input-field" placeholder="e.g. 55">
                        <div id="ageConflict" class="conflict-message"></div> </div>
                </div>
                <div class="field-group">
                    <div>
                        <label for="sex" class="input-label">Sex</label>
                        <div class="select-wrapper">
                            <select id="sex" class="select-field">
                                <option value="">Select Sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="recordingDate" class="input-label">Recording Date</label>
                        <input type="date" id="recordingDate" class="input-field">
                        <div id="recordingDateConflict" class="conflict-message"></div> </div>
                </div>
                <div style="margin-top: 25px;">
                    <label for="clinicalHistory" class="input-label">Brief Clinical History / Symptoms</label>
                    <textarea id="clinicalHistory" class="input-field" placeholder="e.g. Chest pain, palpitations"></textarea>
                </div>
            </div>
            <div class="bottom-pagination-controls">
                <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                <button class="pagination-button next" onclick="changePage(1)">Next</button>
            </div>
        </div>

        <div class="page" id="page2" style="display: none;">
            <div class="form-section">
                <h2>P Wave Abnormalities</h2>
                <div class="field-group">
                    <div>
                        <label for="pWaveDuration" class="input-label">P wave duration (ms)</label>
                        <input type="number" id="pWaveDuration" class="input-field" placeholder="e.g. 110">
                        <div id="pWaveDurationRange" class="range-info"></div>
                        <div id="pWaveDurationFlag" class="flag-message"></div>
                    </div>
                    <div>
                        <label for="pWaveShape" class="input-label">P wave shape</label>
                        <div class="select-wrapper">
                            <select id="pWaveShape" class="select-field">
                                <option value="">Select</option>
                                <option value="Normal">Normal</option>
                                <option value="Peaked">Peaked</option>
                                <option value="Bifid">Bifid</option>
                                <option value="Absent">Absent</option>
                                <option value="Sawtooth">Sawtooth</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 25px;">
                    <label for="atrialEnlargement" class="input-label">Atrial enlargement</label>
                    <div class="select-wrapper">
                        <select id="atrialEnlargement" class="select-field">
                            <option value="">Select</option>
                            <option value="None">None</option>
                            <option value="Left Atrial Enlargement">Left Atrial Enlargement</option>
                            <option value="Right Atrial Enlargement">Right Atrial Enlargement</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>PR Interval</h2>
                <div class="field-group">
                    <div>
                        <label for="prInterval" class="input-label">PR interval (ms)</label>
                        <input type="number" id="prInterval" class="input-field" placeholder="e.g. 160">
                        <div id="prIntervalRange" class="range-info"></div>
                        <div id="prIntervalFlag" class="flag-message"></div>
                    </div>
                    <div>
                        <label for="avBlockType" class="input-label">AV Block Type</label>
                        <div class="select-wrapper">
                            <select id="avBlockType" class="select-field">
                                <option value="">Select</option>
                                <option value="None">None</option>
                                <option value="Mobitz I (Wenckebach)">Mobitz I (Wenckebach)</option>
                                <option value="Mobitz II">Mobitz II</option>
                                <option value="3rd Degree">3rd Degree</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
             <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                 <button class="pagination-button next" onclick="changePage(1)">Next</button>
             </div>
        </div>

        <div class="page" id="page3" style="display: none;">
            <div class="form-section">
                <h2>QRS Complex</h2>
                <div class="field-group">
                    <div>
                        <label for="qrsDuration" class="input-label">QRS duration (ms)</label>
                        <input type="number" id="qrsDuration" class="input-field" placeholder="e.g. 130">
                         <div id="qrsDurationRange" class="range-info"></div>
                        <div id="qrsDurationFlag" class="flag-message"></div>
                    </div>
                    <div>
                        <label for="qrsMorphology" class="input-label">QRS morphology</label>
                        <div class="select-wrapper">
                            <select id="qrsMorphology" class="select-field">
                                <option value="">Select</option>
                                <option value="Normal">Normal</option>
                                <option value="RBBB">RBBB</option>
                                <option value="LBBB">LBBB</option>
                                <option value="Delta wave">Delta wave</option>
                                <option value="Notching/Slurring">Notching/Slurring</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group">
                     <div>
                         <label for="qrsVoltage" class="input-label">QRS voltage</label>
                         <div class="select-wrapper">
                             <select id="qrsVoltage" class="select-field">
                                 <option value="">Select</option>
                                 <option value="Normal">Normal</option>
                                 <option value="Low voltage">Low voltage</option>
                                 <option value="Electrical alternans">Electrical alternans</option>
                             </select>
                         </div>
                     </div>
                     <div>
                         <label for="rWaveProgression" class="input-label">R wave progression</label>
                         <div class="select-wrapper">
                             <select id="rWaveProgression" class="select-field">
                                 <option value="">Select</option>
                                 <option value="Normal">Normal</option>
                                 <option value="Poor">Poor</option>
                                 <option value="Reverse">Reverse</option>
                             </select>
                         </div>
                     </div>
                </div>
                <div class="checkbox-group" style="margin-top: 25px;">
                     <label class="checkbox-label" for="rsRatioAbnormal">
                         <input type="checkbox" id="rsRatioAbnormal" name="qrsComplexChecks"> Precordial leads R/S ratio abnormal
                     </label>
                     <label class="checkbox-label" for="pathologicQWaves">
                         <input type="checkbox" id="pathologicQWaves" name="qrsComplexChecks"> Pathologic Q waves Present
                     </label>
                </div>
            </div>
             <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                 <button class="pagination-button next" onclick="changePage(1)">Next</button>
             </div>
        </div>

        <div class="page" id="page4" style="display: none;">
            <div class="form-section">
                <h2>QT Interval</h2>
                 <div class="field-group">
                     <div>
                         <label for="qtcInterval" class="input-label">QTc interval (ms)</label>
                         <input type="number" id="qtcInterval" class="input-field" placeholder="Auto-corrected QT interval">
                          <div id="qtcIntervalRange" class="range-info"></div>
                          <div id="qtcIntervalFlag" class="flag-message"></div>
                     </div>
                     <div>
                         <label for="qtAbnormality" class="input-label">QT abnormality</label>
                         <div class="select-wrapper">
                             <select id="qtAbnormality" class="select-field">
                                 <option value="">Select</option>
                                 <option value="Normal">Normal</option>
                                 <option value="Prolonged">Prolonged</option>
                                 <option value="Shortened">Shortened</option>
                                 <option value="Torsades de Pointes">Torsades de Pointes</option>
                             </select>
                         </div>
                     </div>
                 </div>
            </div>
            <div class="form-section">
                <h2>Axis Deviation</h2>
                <div style="margin-top: 0;">
                    <label for="qrsAxis" class="input-label">QRS Axis</label>
                    <div class="select-wrapper">
                        <select id="qrsAxis" class="select-field">
                            <option value="">Select</option>
                            <option value="Normal">Normal</option>
                            <option value="Left Axis Deviation">Left Axis Deviation</option>
                            <option value="Right Axis Deviation">Right Axis Deviation</option>
                            <option value="Extreme Axis">Extreme Axis</option>
                        </select>
                    </div>
                </div>
            </div>
             <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                 <button class="pagination-button next" onclick="changePage(1)">Next</button>
             </div>
        </div>

        <div class="page" id="page5" style="display: none;">
            <div class="form-section">
                <h2>ST Segment Abnormalities</h2>
                <div class="checkbox-group" id="stSegmentAbnormalitiesGroup">
                    <label class="checkbox-label" for="stElevation">
                        <input type="checkbox" id="stElevation" name="stSegmentStatus" value="elevation"> ST elevation Present
                    </label>
                    <label class="checkbox-label" for="stDepression">
                        <input type="checkbox" id="stDepression" name="stSegmentStatus" value="depression"> ST depression Present
                    </label>
                     <label class="checkbox-label" for="stNormal">
                         <input type="checkbox" id="stNormal" name="stSegmentStatus" value="normal"> ST segment Normal
                     </label>
                    <label class="checkbox-label" for="earlyRepolarization">
                        <input type="checkbox" id="earlyRepolarization" name="stSegmentStatus" value="earlyRepolarization"> Early repolarization Present
                    </label>
                    <label class="checkbox-label" for="osbornJWaves">
                        <input type="checkbox" id="osbornJWaves" name="stSegmentStatus" value="osbornJWaves"> Osborn (J) waves Present
                    </label>
                    <label class="checkbox-label" for="nonspecificSTTChanges">
                        <input type="checkbox" id="nonspecificSTTChanges" name="stSegmentStatus" value="nonspecific"> Non-specific ST/T changes Present
                    </label>
                </div>
            </div>
            <div class="form-section">
                <h2>T and U Waves</h2>
                <div class="field-group">
                    <div>
                        <label for="tWaveAbnormalities" class="input-label">T wave abnormalities</label>
                        <div class="select-wrapper">
                            <select id="tWaveAbnormalities" class="select-field">
                                <option value="">Select</option>
                                <option value="Normal">Normal</option>
                                <option value="Inverted">Inverted</option>
                                <option value="Tall">Tall</option>
                                <option value="Hyperacute">Hyperacute</option>
                            </select>
                        </div>
                    </div>
                     <div></div>
                </div>
                 <div class="checkbox-group" style="margin-top: 25px;">
                     <label class="checkbox-label" for="uWaveProminence">
                         <input type="checkbox" id="uWaveProminence" name="tuWaveChecks"> U wave prominence Present
                     </label>
                 </div>
            </div>
             <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                 <button class="pagination-button next" onclick="changePage(1)">Next</button>
             </div>
        </div>

        <div class="page" id="page6" style="display: none;">
            <div class="form-section">
                <h2>Rhythm and Rate</h2>
                <div class="field-group">
                    <div>
                        <label for="heartRate" class="input-label">Heart rate (bpm)</label>
                        <input type="number" id="heartRate" class="input-field" placeholder="e.g. 75">
                        <div id="heartRateRange" class="range-info"></div>
                        <div id="heartRateFlag" class="flag-message"></div>
                    </div>
                    <div>
                        <label for="rhythm" class="input-label">Rhythm</label>
                        <div class="select-wrapper">
                            <select id="rhythm" class="select-field">
                                <option value="">Select</option>
                                <option value="Sinus rhythm">Sinus rhythm</option>
                                <option value="Sinus bradycardia">Sinus bradycardia</option>
                                <option value="Sinus tachycardia">Sinus tachycardia</option>
                                <option value="Atrial fibrillation">Atrial fibrillation</option>
                                <option value="Atrial flutter">Atrial flutter</option>
                                <option value="Supraventricular tachycardia">Supraventricular tachycardia</option>
                                <option value="Ventricular tachycardia">Ventricular tachycardia</option>
                                <option value="Ventricular fibrillation">Ventricular fibrillation</option>
                                <option value="Junctional rhythm">Junctional rhythm</option>
                                <option value="Idioventricular rhythm">Idioventricular rhythm</option>
                                <option value="Asystole">Asystole</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="checkbox-group" style="margin-top: 25px;">
                    <label class="checkbox-label" for="pacemakerPresent">
                        <input type="checkbox" id="pacemakerPresent" name="rhythmChecks"> Pacemaker present
                    </label>
                    <label class="checkbox-label" for="ectopicBeats">
                        <input type="checkbox" id="ectopicBeats" name="rhythmChecks"> Ectopic beats Present
                    </label>
                </div>
            </div>
             <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
                 <button class="pagination-button next" onclick="changePage(1)">Next</button>
             </div>
        </div>

        <div class="page" id="page7" style="display: none;">
            <div class="form-section">
                <h2>Analysis and Actions</h2>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="analyzeBtn" onclick="analyzeECG()">Analyze ECG</button>
                    <button id="exportExcelBtn" onclick="exportToCSV()" style="margin-left: 20px;">Export to CSV</button>
                </div>
                <div id="analysisMessages"></div>
            </div>

            <div id="analysisResults" class="form-section" style="display: none;">
                <h2>Analysis Results</h2>
                <div id="analysisSummary"></div>

                <h3>Rule Checks (OK):</h3>
                <button id="toggleOkRulesBtn" style="display: none;">Show Rules Met</button>
                <div id="okRulesListContainer">
                </div>

                <div id="notOkRulesSection" style="display: none;"> <h3>Rules Not Met:</h3>
                    <ul id="notOkRulesList" class="not-ok-rules-list"></ul>
                </div>
                 <button id="toggleNotOkRulesBtn" style="display: none; margin-top: 15px;">Show Rules Not Met</button>
            </div>

            <div id="firstInterpreterSection" class="form-section" style="display: none;">
                <h2>First Interpreter</h2> <button id="toggleFirstInterpreterBtn" style="display: none;">Show First Interpretations</button>
                <div id="firstInterpretationListContainer">
                    <ul id="firstInterpretationList" class="not-ok-rules-list"></ul>
                </div>
            </div>

            <div id="deepInterpreterSection" class="form-section" style="display: none;"> <h2>Deep Interpreter</h2>
                <div id="deepInterpretationContent">
                    <p>        ECG     .</p>
                </div>
            </div>

            <div class="bottom-pagination-controls">
                 <button class="pagination-button back" onclick="changePage(-1)">Previous</button>
            </div>
            <canvas id="wavyCanvas7" class="wavy-canvas"></canvas>
        </div>

    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="hideModal()">&times;</span>
            <div id="modalMessage"></div>
        </div>
    </div>


    <script>
        let currentPage = 1;
        const totalPages = 7;
        let animationFrameId = null;
        let currentCanvas = null;
        let currentCtx = null;

        // Global object to store the validation status of each page
        const pageValidationStatus = {}; // e.g., { 1: 'ok', 2: 'warning', 3: 'error', 4: 'none' }

        // Define Normal and Overall Ranges for numeric inputs
        const ranges = {
            pWaveDuration: { normal: [80, 110], overall: [0, 200] },
            prInterval: { normal: [120, 200], overall: [0, 500] },
            qrsDuration: { normal: [80, 100], overall: [0, 300] },
            qtcInterval: { normal: [350, 440], overall: [0, 700] },
            heartRate: { normal: [60, 100], overall: [0, 300] }
        };

        // Mapping of page numbers to descriptive names
        const pageNames = {
            1: "Patient Information",
            2: "P Wave & PR Interval",
            3: "QRS Complex",
            4: "QT & Axis",
            5: "ST, T, U Waves",
            6: "Rhythm and Rate",
            7: "Analysis & Actions"
        };


        // Function to show a specific page
        function showPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            const targetPage = document.getElementById('page' + pageNumber);
            if (targetPage) {
                targetPage.style.display = 'block';

                const allCanvases = document.querySelectorAll('.wavy-canvas');
                allCanvases.forEach(canvas => {
                    canvas.style.display = 'none';
                });

                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                currentCtx = null;
            }
        }

        // Function to update pagination button states and text
        function updatePaginationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const bottomPrevBtn = document.querySelector('#page' + currentPage + ' .bottom-pagination-controls .back');
            const bottomNextBtn = document.querySelector('#page' + currentPage + ' .bottom-pagination-controls .next');

            if (currentPage === 1) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }

            if (currentPage === totalPages) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }

            if (bottomPrevBtn) {
                 if (currentPage === 1) {
                     bottomPrevBtn.style.display = 'none';
                 } else {
                     bottomPrevBtn.style.display = 'inline-flex';
                 }
            }

            if (bottomNextBtn) {
                 if (currentPage === totalPages) {
                     bottomNextBtn.style.display = 'none';
                 } else {
                     bottomNextBtn.style.display = 'inline-flex';
                 }
            }
            updateStepButtons(); // Also update the step buttons for colors
            updateStepDropdown(); // Update the dropdown selection
        }

        // Function to update the step buttons (colors and text)
        function updateStepButtons() {
            const stepButtonsContainer = document.getElementById('stepButtonsContainer');
            stepButtonsContainer.innerHTML = ''; // Clear existing buttons

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.classList.add('step-button');
                button.textContent = `Step ${i}`;
                button.onclick = () => goToPage(i);

                let statusClass = '';
                if (i === currentPage) {
                    statusClass = 'step-blue';
                } else {
                    const status = pageValidationStatus[i];
                    if (status === 'ok') {
                        statusClass = 'step-green';
                    } else if (status === 'warning') {
                        statusClass = 'step-yellow';
                    } else if (status === 'error') {
                        statusClass = 'step-red';
                    } else {
                        statusClass = 'step-white';
                    }
                }
                button.classList.add(statusClass);
                stepButtonsContainer.appendChild(button);
            }
        }

        // Function to update the step dropdown
        function updateStepDropdown() {
            const stepDropdown = document.getElementById('stepDropdown');
            stepDropdown.innerHTML = ''; // Clear existing options

            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Step ${i}: ${pageNames[i]}`;
                if (i === currentPage) {
                    option.selected = true;
                }
                stepDropdown.appendChild(option);
            }
        }

        // Function to change the current page
        function changePage(direction) {
            validateCurrentPageAndSetStatus(); // Validate current page before moving
            const nextPage = currentPage + direction;
            if (nextPage >= 1 && nextPage <= totalPages) {
                if (nextPage === 1) {
                    resetForm(); // Reset if navigating to page 1
                } else {
                    currentPage = nextPage;
                    showPage(currentPage);
                    updatePaginationButtons();
                    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Function to go to a specific page (from dropdown or step buttons)
        function goToPage(pageNumber) {
            validateCurrentPageAndSetStatus(); // Validate current page before moving
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                if (pageNumber === 1) {
                    resetForm(); // Reset if navigating to page 1
                } else {
                    currentPage = pageNumber;
                    showPage(currentPage);
                    updatePaginationButtons();
                    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Function to handle checkbox/radio label selection styling
        function setupCheckboxRadioListeners() {
            document.querySelectorAll('.checkbox-label input[type="checkbox"]').forEach(checkbox => {
                checkbox.parentElement.classList.toggle('selected', checkbox.checked);
                checkbox.addEventListener('change', function() {
                    this.parentElement.classList.toggle('selected', this.checked);
                    checkConflicts(); // Re-check conflicts on change
                    updateOptionStates(); // Re-update option states
                });
            });

            document.querySelectorAll('.radio-label input[type="radio"]').forEach(radio => {
                 radio.parentElement.classList.toggle('selected', radio.checked);
                 radio.addEventListener('change', function() {
                     document.querySelectorAll(`input[name="${this.name}"]`).forEach(otherRadio => {
                         otherRadio.parentElement.classList.remove('selected');
                     });
                     this.parentElement.classList.add('selected');
                     checkConflicts(); // Re-check conflicts on change
                     updateOptionStates(); // Re-update option states
                 });
            });
        }

        // Function to update range display and flag
        function updateRangeAndFlag(inputId) {
            const inputField = document.getElementById(inputId);
            const rangeInfoDiv = document.getElementById(inputId + 'Range');
            const flagMessageDiv = document.getElementById(inputId + 'Flag');
            const value = parseFloat(inputField.value);
            const range = ranges[inputId];

            if (!range || !rangeInfoDiv || !flagMessageDiv) {
                return;
            }

            rangeInfoDiv.innerHTML = `<span class="normal-range">Normal: ${range.normal[0]}-${range.normal[1]}</span>`;

            let overallRangeText = ` / Overall: ${range.overall[0]}-${range.overall[1]}`;
            let isOutsideOverall = false;
            if (isValidNumber(value) && (value < range.overall[0] || value > range.overall[1])) {
                 overallRangeText = ` / <span class="overall-range error">Overall: ${range.overall[0]}-${range.overall[1]}</span>`;
                 isOutsideOverall = true;
            } else {
                 overallRangeText = ` / <span class="overall-range">${range.overall[0]}-${range.overall[1]}</span>`;
            }
            rangeInfoDiv.innerHTML += overallRangeText;

            if (isValidNumber(value) && (value < range.normal[0] || value > range.normal[1])) {
                if (!isOutsideOverall) {
                     inputField.classList.add('flagged');
                     flagMessageDiv.textContent = `${inputField.previousElementSibling.textContent.replace(':', '')} is outside the normal range.`;
                     inputField.classList.remove('conflict-highlight', 'warning-highlight');
                } else {
                     inputField.classList.remove('flagged');
                     flagMessageDiv.textContent = `Value is outside the overall expected range.`;
                     inputField.classList.add('conflict-highlight');
                     inputField.classList.remove('warning-highlight');
                }
            } else {
                inputField.classList.remove('flagged');
                flagMessageDiv.textContent = '';
                inputField.classList.remove('conflict-highlight', 'warning-highlight');
            }
            // Trigger conflict check and option state update after range/flag changes
            checkConflicts();
            updateOptionStates();
        }

        // Function to handle input validation and flagging
        function setupInputValidationListeners() {
            for (const inputId in ranges) {
                const inputField = document.getElementById(inputId);
                if (inputField) {
                    inputField.addEventListener('input', () => updateRangeAndFlag(inputId));
                    if (inputField.value !== '') {
                        updateRangeAndFlag(inputId);
                    }
                }
            }
        }

         // Helper function to check if a value is a valid number
         function isValidNumber(value) {
             return value !== null && value !== '' && !isNaN(value);
         }

        // Function to check for conflicting selections
        function checkConflicts() {
            clearAllConflictHighlights();
            clearAllConflictMessages();
            clearAllFlagMessages();

            const conflicts = []; // Stores objects like { fields: [], message: '', type: 'error'/'warning' }

            const age = parseFloat(document.getElementById('age').value);
            const recordingDateStr = document.getElementById('recordingDate').value;
            const recordingDate = recordingDateStr ? new Date(recordingDateStr) : null;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const heartRate = parseFloat(document.getElementById('heartRate').value);
            const rhythm = document.getElementById('rhythm').value;
            const pWaveShape = document.getElementById('pWaveShape').value;
            const stSegmentStatuses = Array.from(document.querySelectorAll('input[name="stSegmentStatus"]:checked')).map(checkbox => checkbox.value);
            const avBlockType = document.getElementById('avBlockType').value;
            const prInterval = parseFloat(document.getElementById('prInterval').value);
            const qrsDuration = parseFloat(document.getElementById('qrsDuration').value);
            const qrsMorphology = document.getElementById('qrsMorphology').value;
            const qrsVoltage = document.getElementById('qrsVoltage').value;
            const pathologicQWaves = document.getElementById('pathologicQWaves').checked;
            const qtcInterval = parseFloat(document.getElementById('qtcInterval').value);
            const qtAbnormality = document.getElementById('qtAbnormality').value;
            const qrsAxis = document.getElementById('qrsAxis').value;
            const tWaveAbnormalities = document.getElementById('tWaveAbnormalities').value;


            // --- Age and Date Validation ---
            if (isValidNumber(age)) {
                if (age <= 0 || age > 150) {
                    conflicts.push({ fields: ['age'], message: 'Error:    1  150  .', type: 'error' });
                }
            }
            if (recordingDate) {
                if (recordingDate > today) {
                    conflicts.push({ fields: ['recordingDate'], message: 'Error:      .', type: 'error' });
                }
                if (isValidNumber(age)) {
                    const approxBirthDate = new Date();
                    approxBirthDate.setFullYear(today.getFullYear() - age);
                    approxBirthDate.setHours(0, 0, 0, 0);
                    if (recordingDate < approxBirthDate) {
                        conflicts.push({ fields: ['recordingDate', 'age'], message: `Error:   (${recordingDateStr})       (  ${age} ) .`, type: 'error' });
                    }
                }
            }

            // --- Heart Rate and Rhythm Conflicts ---
            if (isValidNumber(heartRate)) {
                if (heartRate < 60) { // Bradycardia
                    if (rhythm === 'Ventricular tachycardia' || rhythm === 'Sinus tachycardia' || rhythm === 'Supraventricular tachycardia') {
                        conflicts.push({ fields: ['heartRate', 'rhythm'], message: `Conflict: Bradycardia (<60 bpm) is inconsistent with ${rhythm}.`, type: 'error' });
                    }
                    if (rhythm === 'Atrial flutter') {
                        conflicts.push({ fields: ['heartRate', 'rhythm'], message: 'Conflict: Bradycardia (<60 bpm) is inconsistent with typical Atrial Flutter rate (around 150 bpm).', type: 'error' });
                    }
                } else if (heartRate > 100) { // Tachycardia
                    if (rhythm === 'Sinus bradycardia' || rhythm === 'Junctional rhythm' || rhythm === 'Idioventricular rhythm') {
                        conflicts.push({ fields: ['heartRate', 'rhythm'], message: `Conflict: Tachycardia (>100 bpm) is inconsistent with ${rhythm}.`, type: 'error' });
                    }
                }
            }

            if (rhythm === 'Atrial fibrillation') {
                 if (rhythm === 'Atrial flutter') {
                     conflicts.push({ fields: ['rhythm'], message: 'Conflict: Atrial Fibrillation (irregular) is inconsistent with Atrial Flutter (typically regular).', type: 'error' });
                 }
                 if (avBlockType === '3rd Degree') {
                      conflicts.push({ fields: ['rhythm', 'avBlockType'], message: 'Conflict: Atrial Fibrillation (irregular) is inconsistent with 3rd Degree AV Block (can be regular).', type: 'error' });
                 }
            }


            // --- ST Segment Conflicts ---
            const stElevationChecked = stSegmentStatuses.includes('elevation');
            const stDepressionChecked = stSegmentStatuses.includes('depression');
            const stNormalChecked = stSegmentStatuses.includes('normal');
            const earlyRepolarizationChecked = stSegmentStatuses.includes('earlyRepolarization');
            const osbornJWavesChecked = stSegmentStatuses.includes('osbornJWaves');
            const nonspecificChecked = stSegmentStatuses.includes('nonspecific');

            if (stNormalChecked && (stElevationChecked || stDepressionChecked || earlyRepolarizationChecked || osbornJWavesChecked || nonspecificChecked)) {
                 conflicts.push({ fields: ['stNormal', 'stElevation', 'stDepression', 'earlyRepolarization', 'osbornJWaves', 'nonspecificSTTChanges'], message: 'Conflict: "ST segment Normal" cannot be selected with other ST segment abnormalities.', type: 'error' });
            }
            if (stElevationChecked) {
                 if (stDepressionChecked) conflicts.push({ fields: ['stElevation', 'stDepression'], message: 'Conflict: ST Elevation and ST Depression cannot coexist.', type: 'error' });
                 if (earlyRepolarizationChecked) conflicts.push({ fields: ['stElevation', 'earlyRepolarization'], message: 'Conflict: ST Elevation is inconsistent with Early Repolarization.', type: 'error' });
                 if (nonspecificChecked) conflicts.push({ fields: ['stElevation', 'nonspecificSTTChanges'], message: 'Conflict: ST Elevation is inconsistent with Non-specific ST/T Changes.', type: 'error' });
            }
            if (stDepressionChecked) {
                 if (osbornJWavesChecked) conflicts.push({ fields: ['stDepression', 'osbornJWaves'], message: 'Conflict: ST Depression is inconsistent with Osborn (J) Waves.', type: 'error' });
            }
            if (earlyRepolarizationChecked) {
                 if (osbornJWavesChecked) conflicts.push({ fields: ['earlyRepolarization', 'osbornJWaves'], message: 'Conflict: Early Repolarization and Osborn (J) Waves are distinct J point elevations.', type: 'error' });
                 if (nonspecificChecked) conflicts.push({ fields: ['earlyRepolarization', 'nonspecificSTTChanges'], message: 'Conflict: Early Repolarization is inconsistent with Non-specific ST/T Changes.', type: 'error' });
            }
            if (osbornJWavesChecked) {
                  if (stElevationChecked) conflicts.push({ fields: ['osbornJWaves', 'stElevation'], message: 'Warning: Osborn (J) Waves are often inconsistent with ST Elevation (except in hypothermia).', type: 'warning' });
                  if (nonspecificChecked) conflicts.push({ fields: ['nonspecificSTTChanges', 'nonspecificSTTChanges'], message: 'Conflict: Osborn (J) Waves are inconsistent with Non-specific ST/T Changes.', type: 'error' });
             }
            if (nonspecificChecked) {
                  if (stElevationChecked) conflicts.push({ fields: ['nonspecificSTTChanges', 'stElevation'], message: 'Conflict: Non-specific ST/T Changes are inconsistent with ST Elevation.', type: 'error' });
                  if (stDepressionChecked) conflicts.push({ fields: ['nonspecificSTTChanges', 'stDepression'], message: 'Conflict: Non-specific ST/T Changes are inconsistent with ST Depression.', type: 'error' });
             }


            // --- P Waves and Conduction Conflicts ---
            if (pWaveShape === 'Absent') {
                 if (avBlockType === '3rd Degree') {
                     conflicts.push({ fields: ['pWaveShape', 'avBlockType'], message: 'Conflict: Absent P waves are inconsistent with 3rd Degree AV Block (which requires P waves).', type: 'error' });
                 }
                 if (pWaveShape === 'Sawtooth') {
                      conflicts.push({ fields: ['pWaveShape'], message: 'Conflict: P wave shape cannot be both Absent and Sawtooth.', type: 'error' });
                 }
                 if (rhythm === 'Atrial flutter') {
                      conflicts.push({ fields: ['pWaveShape', 'rhythm'], message: 'Conflict: Absent P waves are inconsistent with Atrial Flutter (which has sawtooth P waves).', type: 'error' });
                 }
            }
            if (pWaveShape === 'Sawtooth') {
                 if (rhythm === 'Atrial fibrillation') {
                      conflicts.push({ fields: ['pWaveShape', 'rhythm'], message: 'Conflict: Sawtooth P waves are inconsistent with Atrial Fibrillation (which has absent P waves).', type: 'error' });
                 }
                 if (isValidNumber(heartRate) && heartRate < 60 && rhythm === 'Atrial flutter') {
                      conflicts.push({ fields: ['heartRate', 'rhythm'], message: 'Warning: Bradycardia (<60 bpm) with Atrial Flutter is unusual unless there is significant AV block (e.g., 4:1 block).', type: 'warning' });
                 }
            }

            // --- QT Interval Conflicts ---
            const qtcNormalRangeMin = ranges.qtcInterval.normal[0];
            const qtcNormalRangeMax = ranges.qtcInterval.normal[1];

            if (qtAbnormality === 'Prolonged') {
                if (qtAbnormality === 'Shortened' || qtAbnormality === 'Normal') {
                     conflicts.push({ fields: ['qtAbnormality'], message: 'Conflict: QT abnormality cannot be both Prolonged and Shortened/Normal.', type: 'error' });
                }
                 if (isValidNumber(qtcInterval) && qtcInterval <= qtcNormalRangeMax) {
                      conflicts.push({ fields: ['qtcInterval', 'qtAbnormality'], message: 'Conflict: Selected "Prolonged QTc" but entered QTc value is within normal limits.', type: 'error' });
                 }
            }
            if (qtAbnormality === 'Shortened') {
                 if (qtAbnormality === 'Prolonged' || qtAbnormality === 'Normal') {
                      conflicts.push({ fields: ['qtAbnormality'], message: 'Conflict: QT abnormality cannot be both Shortened and Prolonged/Normal.', type: 'error' });
                 }
                 if (isValidNumber(qtcInterval) && qtcInterval >= qtcNormalRangeMin) {
                      conflicts.push({ fields: ['qtcInterval', 'qtAbnormality'], message: 'Conflict: Selected "Shortened QTc" but entered QTc value is within normal limits.', type: 'error' });
                 }
            }
            if (qtAbnormality === 'Torsades de Pointes') {
                  if (qtAbnormality === 'Normal') {
                       conflicts.push({ fields: ['qtAbnormality'], message: 'Conflict: Torsades de Pointes is inconsistent with Normal QT Interval.', type: 'error' });
                  }
                  if (isValidNumber(heartRate) && heartRate < 60 && avBlockType !== '3rd Degree') {
                       conflicts.push({ fields: ['heartRate', 'rhythm'], message: 'Warning: Torsades de Pointes is usually associated with prolonged QT and not bradycardia, unless due to complete AV block.', type: 'warning' });
                  }
                  if (isValidNumber(qtcInterval) && qtcInterval <= qtcNormalRangeMax) {
                        conflicts.push({ fields: ['qtcInterval', 'qtAbnormality'], message: `Conflict: QTc interval (${qtcInterval} ms) is normal, but "Torsades de Pointes" is selected. Torsades de Pointes usually occurs with prolonged QTc.`, type: 'warning' });
                  }
            }

            // --- QRS Complex Conflicts ---
            const isWPWPattern = (isValidNumber(prInterval) && prInterval < 120) && qrsMorphology === 'Delta wave' && (isValidNumber(qrsDuration) && qrsDuration > 100);
            if (isWPWPattern) {
                if (qrsMorphology === 'LBBB' || qrsMorphology === 'RBBB') {
                     conflicts.push({ fields: ['qrsMorphology'], message: 'Conflict: WPW pattern (Delta wave) is inconsistent with LBBB or RBBB morphology.', type: 'error' });
                }
                 if (qrsAxis === 'Left Axis Deviation') {
                     conflicts.push({ fields: ['qrsAxis'], message: 'Warning: WPW pattern is often associated with RAD or normal axis, less commonly LAD.', type: 'warning' });
                 }
            }
            if (pathologicQWaves && !stElevationChecked && !stDepressionChecked) {
                 conflicts.push({ fields: ['pathologicQWaves'], message: 'Warning: Pathologic Q waves are indicative of previous myocardial infarction. Consider related ST changes.', type: 'warning' });
            }


            // Highlight conflicting fields and display messages
            conflicts.forEach(conflict => {
                conflict.fields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            element.parentElement.classList.add(conflict.type === 'error' ? 'conflict-highlight' : 'warning-highlight');
                            if (fieldId === conflict.fields[0]) {
                                let messageDiv = document.createElement('div');
                                messageDiv.classList.add(conflict.type === 'error' ? 'conflict-message' : 'warning-message');
                                messageDiv.textContent = conflict.message;
                                element.parentElement.after(messageDiv);
                            }
                        } else {
                             element.classList.add(conflict.type === 'error' ? 'conflict-highlight' : 'warning-highlight');
                             let messageDivId = fieldId + 'Conflict';
                             let messageDiv = document.getElementById(messageDivId);
                             if (!messageDiv) {
                                 messageDiv = document.createElement('div');
                                 messageDiv.id = messageDivId;
                                 element.parentNode.appendChild(messageDiv);
                             }
                             messageDiv.classList.add(conflict.type === 'error' ? 'conflict-message' : 'warning-message');
                             messageDiv.textContent = conflict.message;
                        }
                    }
                });
            });

            return conflicts;
        }

        // Function to determine and set the validation status of the current page
        function validateCurrentPageAndSetStatus() {
            const currentConflicts = checkConflicts();
            let hasErrors = false;
            let hasWarnings = false;

            // Check for errors/warnings from range checks on current page inputs
            const currentPageElements = document.getElementById(`page${currentPage}`).querySelectorAll('input, select, textarea');
            currentPageElements.forEach(element => {
                const inputId = element.id;
                if (ranges[inputId]) {
                    const value = parseFloat(element.value);
                    const range = ranges[inputId];
                    if (isValidNumber(value) && (value < range.overall[0] || value > range.overall[1])) {
                        hasErrors = true; // Value outside overall range is an error
                    } else if (isValidNumber(value) && (value < range.normal[0] || value > range.normal[1])) {
                        hasWarnings = true; // Value outside normal range is a warning
                    }
                }
            });

            // Check for errors/warnings from conflict checks
            currentConflicts.forEach(issue => {
                if (issue.type === 'error') {
                    hasErrors = true;
                } else if (issue.type === 'warning') {
                    hasWarnings = true;
                }
            });

            let pageOverallStatus = 'ok';
            if (hasErrors) {
                pageOverallStatus = 'error';
            } else if (hasWarnings) {
                pageOverallStatus = 'warning';
            }

            pageValidationStatus[currentPage] = pageOverallStatus;
            updateStepButtons(); // Update step button colors immediately
        }


        // Function to disable/enable options based on conflicts
        function updateOptionStates() {
             document.querySelectorAll('select option:disabled').forEach(el => {
                 el.disabled = false;
             });
             document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
                  input.disabled = false;
                  input.parentElement.classList.remove('radio-label:has(input:disabled)', 'checkbox-label:has(input:disabled)');
                  input.parentElement.style.opacity = '';
                  input.parentElement.style.cursor = '';
                  input.parentElement.style.borderColor = '';
                  input.parentElement.style.color = '';
             });

             document.querySelectorAll('.radio-group input[type="radio"], .checkbox-group input[type="checkbox"]').forEach(input => {
                 if (input.checked) {
                     input.parentElement.classList.add('selected');
                 } else {
                      input.parentElement.classList.remove('selected');
                 }
             });

             const heartRate = parseFloat(document.getElementById('heartRate').value);
             const rhythm = document.getElementById('rhythm').value;
             const pWaveShape = document.getElementById('pWaveShape').value;
             const stElevationChecked = document.getElementById('stElevation').checked;
             const stDepressionChecked = document.getElementById('stDepression').checked;
             const stNormalChecked = document.getElementById('stNormal').checked;
             const earlyRepolarizationChecked = document.getElementById('earlyRepolarization').checked;
             const osbornJWavesChecked = document.getElementById('osbornJWaves').checked;
             const nonspecificChecked = document.getElementById('nonspecificSTTChanges').checked;
             const avBlockType = document.getElementById('avBlockType').value;
             const qtcInterval = parseFloat(document.getElementById('qtcInterval').value);

             if (isValidNumber(heartRate)) {
                 if (heartRate < 60) {
                     document.querySelector('#rhythm option[value="Sinus tachycardia"]').disabled = true;
                     document.querySelector('#rhythm option[value="Supraventricular tachycardia"]').disabled = true;
                     document.querySelector('#rhythm option[value="Ventricular tachycardia"]').disabled = true;
                 } else if (heartRate > 100) {
                      document.querySelector('#rhythm option[value="Sinus bradycardia"]').disabled = true;
                      document.querySelector('#rhythm option[value="Junctional rhythm"]').disabled = true;
                      document.querySelector('#rhythm option[value="Idioventricular rhythm"]').disabled = true;
                 }
             }

             if (rhythm === 'Atrial fibrillation') {
                  document.querySelector('#rhythm option[value="Atrial flutter"]').disabled = true;
             }
             if (rhythm === 'Atrial flutter') {
                 document.querySelector('#rhythm option[value="Atrial fibrillation"]').disabled = true;
             }
             if (rhythm === '3rd Degree') {
                 document.querySelector('#rhythm option[value="Atrial fibrillation"]').disabled = true;
             }

             if (pWaveShape === 'Absent') {
                  document.querySelector('#avBlockType option[value="3rd Degree"]').disabled = true;
                  document.querySelector('#rhythm option[value="Atrial flutter"]').disabled = true;
             }
             if (pWaveShape === 'Sawtooth') {
                  document.querySelector('#pWaveShape option[value="Absent"]').disabled = true;
                  document.querySelector('#rhythm option[value="Atrial fibrillation"]').disabled = true;
             }
             if (pWaveShape === 'Normal' || pWaveShape === 'Peaked' || pWaveShape === 'Bifid') {
                  document.querySelector('#rhythm option[value="Atrial fibrillation"]').disabled = true;
             }

             if (stNormalChecked) {
                  document.getElementById('stElevation').disabled = true;
                  document.getElementById('stDepression').disabled = true;
                  document.getElementById('earlyRepolarization').disabled = true;
                  document.getElementById('osbornJWaves').disabled = true;
                  document.getElementById('nonspecificSTTChanges').disabled = true;
             }
             if (stElevationChecked) {
                  document.getElementById('stNormal').disabled = true;
                  document.getElementById('stDepression').disabled = true;
                  document.getElementById('earlyRepolarization').disabled = true;
                  document.getElementById('nonspecificSTTChanges').disabled = true;
             }
             if (stDepressionChecked) {
                  document.getElementById('stNormal').disabled = true;
                  document.getElementById('stElevation').disabled = true;
                  document.getElementById('osbornJWaves').disabled = true;
             }
             if (earlyRepolarizationChecked) {
                 document.getElementById('stNormal').disabled = true;
                 document.getElementById('stElevation').disabled = true;
                 document.getElementById('osbornJWaves').disabled = true;
                 document.getElementById('nonspecificSTTChanges').disabled = true;
             }
             if (osbornJWavesChecked) {
                  document.getElementById('stNormal').disabled = true;
                  document.getElementById('stDepression').disabled = true;
                  document.getElementById('earlyRepolarization').disabled = true;
                  document.getElementById('nonspecificSTTChanges').disabled = true;
             }
             if (nonspecificChecked) {
                  document.getElementById('stNormal').disabled = true;
                  document.getElementById('stElevation').disabled = true;
                  document.getElementById('stDepression').disabled = true;
                  document.getElementById('earlyRepolarization').disabled = true;
                  document.getElementById('osbornJWaves').disabled = true;
             }

             const qtcNormalRangeMin = ranges.qtcInterval.normal[0];
             const qtcNormalRangeMax = ranges.qtcInterval.normal[1];

             if (isValidNumber(qtcInterval)) {
                 if (qtcInterval < qtcNormalRangeMin) {
                     document.querySelector('#qtAbnormality option[value="Normal"]').disabled = true;
                     document.querySelector('#qtAbnormality option[value="Prolonged"]').disabled = true;
                     document.querySelector('#qtAbnormality option[value="Torsades de Pointes"]').disabled = true;
                 } else if (qtcInterval > qtcNormalRangeMax) {
                     document.querySelector('#qtAbnormality option[value="Normal"]').disabled = true;
                     document.querySelector('#qtAbnormality option[value="Shortened"]').disabled = true;
                 } else {
                     document.querySelector('#qtAbnormality option[value="Prolonged"]').disabled = true;
                     document.querySelector('#qtAbnormality option[value="Shortened"]').disabled = true;
                     document.querySelector('#qtAbnormality option[value="Torsades de Pointes"]').disabled = true;
                 }
             }

             document.querySelectorAll('input[type="radio"]:disabled, input[type="checkbox"]:disabled').forEach(input => {
                 input.parentElement.classList.add(input.type === 'radio' ? 'radio-label:has(input:disabled)' : 'checkbox-label:has(input:disabled)');
                 input.parentElement.style.opacity = '0.6';
                 input.parentElement.style.cursor = 'not-allowed';
                 input.parentElement.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--flag-color');
                 input.parentElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--flag-color');
             });

             document.querySelectorAll('.radio-group input[type="radio"], .checkbox-group input[type="checkbox"]').forEach(input => {
                 if (input.checked && !input.disabled) {
                     input.parentElement.classList.add('selected');
                 } else {
                      input.parentElement.classList.remove('selected');
                 }
             });
        }

        function clearAllConflictHighlights() {
             document.querySelectorAll('.conflict-highlight, .warning-highlight').forEach(element => {
                 element.classList.remove('conflict-highlight', 'warning-highlight');
             });
        }

         function clearAllConflictMessages() {
             document.querySelectorAll('.conflict-message, .warning-message').forEach(element => {
                 element.textContent = '';
                 element.classList.remove('conflict-message', 'warning-message');
             });
         }

        function clearAllFlagMessages() {
            document.querySelectorAll('.flag-message').forEach(element => {
                element.textContent = '';
            });
             document.querySelectorAll('.input-field.flagged').forEach(element => {
                 element.classList.remove('flagged');
             });
        }

        function clearAllValidationMessages() {
            clearAllFlagMessages();
            clearAllConflictHighlights();
            clearAllConflictMessages();
             document.querySelectorAll('.overall-range.error').forEach(span => {
                 span.classList.remove('error');
             });
             document.querySelectorAll('.input-field.conflict-highlight, .input-field.warning-highlight').forEach(input => {
                 input.classList.remove('conflict-highlight', 'warning-highlight');
             });
        }

        function showModal(message) {
            const modal = document.getElementById('myModal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.innerHTML = message;
            modal.style.display = 'block';
        }

        function hideModal() {
            const modal = document.getElementById('myModal');
            modal.style.display = 'none';
             document.getElementById('modalMessage').innerHTML = '';
        }

        function analyzeECG() {
            clearAllValidationMessages();
            clearAnalysisResults();
            document.getElementById('analysisMessages').innerHTML = '';

            const analyzeBtn = document.getElementById('analyzeBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const analysisResultsDiv = document.getElementById('analysisResults');
            const analysisSummaryDiv = document.getElementById('analysisSummary');
            const notOkRulesSection = document.getElementById('notOkRulesSection');
            const notOkRulesListUl = document.getElementById('notOkRulesList');
            const okRulesListContainerDiv = document.getElementById('okRulesListContainer');
            const toggleNotOkRulesBtn = document.getElementById('toggleNotOkRulesBtn');
            const toggleOkRulesBtn = document.getElementById('toggleOkRulesBtn');
            const firstInterpreterSection = document.getElementById('firstInterpreterSection'); // Renamed
            const firstInterpretationListUl = document.getElementById('firstInterpretationList'); // Renamed
            const toggleFirstInterpreterBtn = document.getElementById('toggleFirstInterpreterBtn'); // Renamed
            const deepInterpreterSection = document.getElementById('deepInterpreterSection'); // New
            const wavyCanvas = document.getElementById('wavyCanvas7');

            analyzeBtn.disabled = true;
            exportExcelBtn.disabled = true;
            const spinner = document.createElement('i');
            spinner.classList.add('fas', 'fa-spinner', 'fa-spin', 'ml-2');
            analyzeBtn.appendChild(spinner);

            // Validate the current (last) page and set its status
            validateCurrentPageAndSetStatus();

            const validationIssues = [];
            for (let i = 1; i <= totalPages; i++) {
                if (pageValidationStatus[i] === 'error') {
                    validationIssues.push({ type: 'error', message: `Step ${i} has errors.` });
                } else if (pageValidationStatus[i] === 'warning') {
                    validationIssues.push({ type: 'warning', message: `Step ${i} has warnings.` });
                }
            }


            if (validationIssues.length > 0) {
                const analysisMessagesDiv = document.getElementById('analysisMessages');
                const ul = document.createElement('ul');

                validationIssues.forEach(issue => {
                    const li = document.createElement('li');
                    li.classList.add(issue.type);
                    li.textContent = `${issue.type === 'error' ? 'Error: ' : 'Warning: '}${issue.message}`;
                    ul.appendChild(li);
                });
                analysisMessagesDiv.appendChild(ul);

                analyzeBtn.disabled = false;
                exportExcelBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze ECG';
                spinner.remove();
                if (wavyCanvas) wavyCanvas.style.display = 'none';
                return;
            }

            const formData = {
                patientId: document.getElementById('patientId').value,
                age: parseFloat(document.getElementById('age').value),
                sex: document.getElementById('sex').value,
                recordingDate: document.getElementById('recordingDate').value,
                clinicalHistory: document.getElementById('clinicalHistory').value,
                pWaveDuration: parseFloat(document.getElementById('pWaveDuration').value),
                pWaveShape: document.getElementById('pWaveShape').value,
                atrialEnlargement: document.getElementById('atrialEnlargement').value,
                prInterval: parseFloat(document.getElementById('prInterval').value),
                avBlockType: document.getElementById('avBlockType').value,
                qrsDuration: parseFloat(document.getElementById('qrsDuration').value),
                qrsMorphology: document.getElementById('qrsMorphology').value,
                qrsVoltage: document.getElementById('qrsVoltage').value,
                rWaveProgression: document.getElementById('rWaveProgression').value,
                rsRatioAbnormal: document.getElementById('rsRatioAbnormal').checked,
                pathologicQWaves: document.getElementById('pathologicQWaves').checked,
                qtcInterval: parseFloat(document.getElementById('qtcInterval').value),
                qtAbnormality: document.getElementById('qtAbnormality').value,
                qrsAxis: document.getElementById('qrsAxis').value,
                stSegmentStatuses: Array.from(document.querySelectorAll('input[name="stSegmentStatus"]:checked')).map(checkbox => checkbox.value),
                tWaveAbnormalities: document.getElementById('tWaveAbnormalities').value,
                uWaveProminence: document.getElementById('uWaveProminence').checked,
                heartRate: parseFloat(document.getElementById('heartRate').value),
                rhythm: document.getElementById('rhythm').value,
                pacemakerPresent: document.getElementById('pacemakerPresent').checked,
                ectopicBeats: document.getElementById('ectopicBeats').checked,
            };

            const analysisSummary = [];
            const ruleChecks = [];
            const notOkRulesListArray = [];

            const interpretationRules = [
                {
                    name: 'Sinus Rhythm Criteria',
                    check: (data) => data.rhythm === 'Sinus rhythm' && data.pWaveShape === 'Normal' && !data.pacemakerPresent && isValidNumber(data.heartRate) && data.heartRate >= 60 && data.heartRate <= 100 && isValidNumber(data.prInterval) && data.prInterval >= 120 && data.prInterval <= 200,
                    getReasonOK: (data) => `Rhythm is Sinus Rhythm (${data.rhythm}), P wave shape is Normal (${data.pWaveShape}), Pacemaker not present, Heart rate (${data.heartRate} bpm) is 60-100 bpm, PR interval (${data.prInterval} ms) is 120-200 ms.`,
                    negativeMessage: (data) => {
                        let reason = [];
                        if (data.rhythm !== 'Sinus rhythm') reason.push(`Rhythm is ${data.rhythm || 'not selected'}`);
                        if (data.pWaveShape !== 'Normal') reason.push(`P wave shape is ${data.pWaveShape || 'not selected'}`);
                        if (data.pacemakerPresent) reason.push('Pacemaker present');
                        if (!(isValidNumber(data.heartRate) && data.heartRate >= 60 && data.heartRate <= 100)) reason.push(`Heart rate (${data.heartRate || 'N/A'}) is outside normal sinus range (60-100 bpm)`);
                        if (!(isValidNumber(data.prInterval) && data.prInterval >= 120 && data.prInterval <= 200)) reason.push(`PR interval (${data.prInterval || 'N/A'}) is outside normal range (120-200 ms)`);
                        return `Criteria not met (${reason.join(', ')})`;
                    }
                },
                {
                    name: 'Bradycardia Detection',
                    check: (data) => isValidNumber(data.heartRate) && data.heartRate < 60,
                    getReasonOK: (data) => `Heart rate (${data.heartRate} bpm) is less than 60 bpm.`,
                    negativeMessage: (data) => isValidNumber(data.heartRate) ? `Heart rate (${data.heartRate} bpm) is not less than 60 bpm.` : 'Heart rate not entered or invalid.'
                },
                {
                    name: 'Tachycardia Detection',
                    check: (data) => isValidNumber(data.heartRate) && data.heartRate > 100,
                    getReasonOK: (data) => `Heart rate (${data.heartRate} bpm) is greater than 100 bpm.`,
                    negativeMessage: (data) => isValidNumber(data.heartRate) ? `Heart rate (${data.heartRate} bpm) is not greater than 100 bpm.` : 'Heart rate not entered or invalid.'
                },
                {
                    name: 'First-Degree AV Block',
                    check: (data) => isValidNumber(data.prInterval) && data.prInterval > 200 && data.avBlockType === 'None',
                    getReasonOK: (data) => `PR interval (${data.prInterval} ms) is > 200ms and no higher degree AV block selected.`,
                    negativeMessage: (data) => {
                         let reason = [];
                         if (!(isValidNumber(data.prInterval) && data.prInterval > 200)) reason.push(`PR interval (${data.prInterval || 'N/A'}) is not > 200 ms`);
                         if (data.avBlockType !== 'None') reason.push(`Higher degree AV block selected (${data.avBlockType})`);
                         return `Criteria not met (${reason.join(', ')})`;
                    }
                },
                 {
                     name: 'Wide QRS Complex',
                     check: (data) => isValidNumber(data.qrsDuration) && data.qrsDuration > 100,
                     getReasonOK: (data) => `QRS duration (${data.qrsDuration} ms) is greater than 100 ms.`,
                     negativeMessage: (data) => isValidNumber(data.qrsDuration) ? `QRS duration (${data.qrsDuration} ms) is not > 100 ms.` : 'QRS duration not entered or invalid.'
                 },
                 {
                     name: 'Left Bundle Branch Block (LBBB)',
                     check: (data) => data.qrsMorphology === 'LBBB' && isValidNumber(data.qrsDuration) && data.qrsDuration > 120,
                     getReasonOK: (data) => `QRS morphology is LBBB and QRS duration (${data.qrsDuration} ms) is > 120 ms.`,
                     negativeMessage: (data) => {
                          let reason = [];
                          if (data.qrsMorphology !== 'LBBB') reason.push(`QRS morphology is not LBBB (${data.qrsMorphology || 'not selected'})`);
                          if (!(isValidNumber(data.qrsDuration) && data.qrsDuration > 120)) reason.push(`QRS duration (${data.qrsDuration || 'N/A'}) is not > 120 ms`);
                          return `Criteria not met (${reason.join(', ')})`;
                     }
                 },
                 {
                     name: 'Right Bundle Branch Block (RBBB)',
                     check: (data) => data.qrsMorphology === 'RBBB' && isValidNumber(data.qrsDuration) && data.qrsDuration > 120,
                     getReasonOK: (data) => `QRS morphology is RBBB and QRS duration (${data.qrsDuration} ms) is > 120 ms.`,
                     negativeMessage: (data) => {
                          let reason = [];
                          if (data.qrsMorphology !== 'RBBB') reason.push(`QRS morphology is not RBBB (${data.qrsMorphology || 'not selected'})`);
                          if (!(isValidNumber(data.qrsDuration) && data.qrsDuration > 120)) reason.push(`QRS duration (${data.qrsDuration || 'N/A'}) is not > 120 ms`);
                          return `Criteria not met (${reason.join(', ')})`;
                     }
                 },
                 {
                     name: 'Pathologic Q Waves',
                     check: (data) => data.pathologicQWaves,
                     getReasonOK: (data) => `Pathologic Q waves checkbox is checked.`,
                     negativeMessage: (data) => 'Pathologic Q waves checkbox is not checked.'
                 },
                 {
                     name: 'ST Elevation Present',
                     check: (data) => data.stSegmentStatuses.includes('elevation'),
                     getReasonOK: (data) => `ST elevation checkbox is checked.`,
                     negativeMessage: (data) => 'ST elevation checkbox is not checked.'
                 },
                 {
                     name: 'ST Depression Present',
                     check: (data) => data.stSegmentStatuses.includes('depression'),
                     getReasonOK: (data) => `ST depression checkbox is checked.`,
                     negativeMessage: (data) => 'ST depression checkbox is not checked.'
                 },
                 {
                     name: 'Prolonged QTc',
                     check: (data) => data.qtAbnormality === 'Prolonged' || (isValidNumber(data.qtcInterval) && data.qtcInterval > 440),
                     getReasonOK: (data) => {
                          let reason = [];
                          if (data.qtAbnormality === 'Prolonged') reason.push('QT abnormality selected as Prolonged');
                          if (isValidNumber(data.qtcInterval) && data.qtcInterval > 440) reason.push(`QTc interval (${data.qtcInterval} ms) is > 440 ms`);
                          return reason.join(' and ');
                     },
                     negativeMessage: (data) => {
                          let reason = [];
                          if (data.qtAbnormality !== 'Prolonged') reason.push(`QT abnormality is not Prolonged (${data.qtAbnormality || 'not selected'})`);
                          if (isValidNumber(data.qtcInterval) && data.qtcInterval <= 440) reason.push(`QTc interval (${data.qtcInterval}) is not prolonged.`);
                          return `Criteria not met (${reason.join(', ')})`;
                     }
                 },
                 {
                     name: 'Atrial Fibrillation',
                     check: (data) => data.rhythm === 'Atrial fibrillation' && data.pWaveShape === 'Absent',
                     getReasonOK: (data) => `Rhythm is Atrial Fibrillation and P wave shape is Absent.`,
                     negativeMessage: (data) => {
                          let reason = [];
                          if (data.rhythm !== 'Atrial fibrillation') reason.push(`Rhythm is not Atrial Fibrillation (${data.rhythm || 'not selected'})`);
                          if (data.pWaveShape !== 'Absent') reason.push(`P wave shape is not Absent (${data.pWaveShape || 'not selected'})`);
                          return `Criteria not met (${reason.join(', ')})`;
                     }
                 }
            ];


            interpretationRules.forEach(rule => {
                const result = rule.check(formData);
                if (result) {
                    ruleChecks.push({ rule: rule.name, status: 'OK', reason: rule.getReasonOK(formData) });
                } else {
                     ruleChecks.push({ rule: rule.name, status: 'NOT OK', reason: rule.negativeMessage(formData) });
                     notOkRulesListArray.push(`${rule.name}: ${rule.negativeMessage(formData)}`);
                }
            });

             if (isValidNumber(formData.heartRate) && formData.heartRate < 60) analysisSummary.push('Bradycardia Present');
             if (isValidNumber(formData.heartRate) && formData.heartRate > 100) analysisSummary.push('Tachycardia Present');
             if (formData.avBlockType !== 'None') analysisSummary.push(`${formData.avBlockType} AV Block Present`);
             if (formData.rhythm !== '' && formData.rhythm !== 'Sinus rhythm') analysisSummary.push(`Rhythm: ${formData.rhythm}`);
             if (isValidNumber(formData.qrsDuration) && formData.qrsDuration > 100) analysisSummary.push('Wide QRS Complex Present');
             formData.stSegmentStatuses.forEach(status => {
                 let displayStatus = status;
                 if (status === 'elevation') displayStatus = 'ST Elevation Present';
                 else if (status === 'depression') displayStatus = 'ST Depression Present';
                 else if (status === 'normal') displayStatus = 'ST segment Normal';
                 else if (status === 'earlyRepolarization') displayStatus = 'Early repolarization Present';
                 else if (status === 'osbornJWaves') displayStatus = 'Osborn (J) waves Present';
                 else if (status === 'nonspecific') displayStatus = 'Non-specific ST/T changes Present';
                 analysisSummary.push(displayStatus);
             });

             if (formData.qtAbnormality === 'Prolonged') analysisSummary.push('Prolonged QTc Present');
             if (formData.qtAbnormality === 'Shortened') analysisSummary.push('Shortened QTc Present');
             if (formData.qrsAxis !== 'Normal' && formData.qrsAxis !== '') analysisSummary.push(`QRS Axis: ${formData.qrsAxis}`);


            analysisSummaryDiv.innerHTML = '<strong>Key Findings:</strong>';
            if (analysisSummary.length > 0) {
                const ul = document.createElement('ul');
                analysisSummary.forEach(finding => {
                    const li = document.createElement('li');
                    li.textContent = finding;
                    ul.appendChild(li);
                });
                analysisSummaryDiv.appendChild(ul);
            } else {
                analysisSummaryDiv.innerHTML += '<p>No significant findings based on selected criteria.</p>';
            }


            okRulesListContainerDiv.innerHTML = '';
            const okRules = ruleChecks.filter(rule => rule.status === 'OK');
            if (okRules.length > 0) {
                 toggleOkRulesBtn.style.display = 'block';
                 toggleOkRulesBtn.textContent = `Hide Rules Met (${okRules.length})`;
                 okRules.forEach((rule, index) => {
                     const ruleItem = document.createElement('div');
                     ruleItem.classList.add('ok-rule-item-clickable');
                     ruleItem.innerHTML = `<strong>${index + 1}: ${rule.rule}</strong><div class="ok-rule-reason-hidden">${rule.reason}</div>`;
                     ruleItem.addEventListener('click', function() {
                         const reasonDiv = this.querySelector('.ok-rule-reason-hidden');
                         if (reasonDiv) {
                             reasonDiv.style.display = reasonDiv.style.display === 'block' ? 'none' : 'block';
                         }
                     });
                     okRulesListContainerDiv.appendChild(ruleItem);
                 });
                 okRulesListContainerDiv.style.display = 'block';
            } else {
                okRulesListContainerDiv.innerHTML = '<p> </p>';
                toggleOkRulesBtn.style.display = 'none';
            }


            notOkRulesListUl.innerHTML = '';
            if (notOkRulesListArray.length > 0) {
                notOkRulesSection.style.display = 'block';
                toggleNotOkRulesBtn.style.display = 'block';
                toggleNotOkRulesBtn.textContent = `Hide Rules Not Met (${notOkRulesListArray.length})`;
                notOkRulesListArray.forEach(rule => {
                    const li = document.createElement('li');
                    li.textContent = rule;
                    notOkRulesListUl.appendChild(li);
                });
                notOkRulesListUl.style.display = 'block';
            } else {
                notOkRulesSection.style.display = 'none';
                toggleNotOkRulesBtn.style.display = 'none';
            }

            firstInterpretECG(formData); // Call the renamed function

            analysisResultsDiv.style.display = 'block';

            if (wavyCanvas) {
                currentCanvas = wavyCanvas;
                currentCtx = wavyCanvas.getContext('2d');
                const container = wavyCanvas.parentElement;
                currentCanvas.width = container.clientWidth;
                currentCanvas.height = 150;

                ecgSpeed = Math.max(2, formData.heartRate / 10);
                currentWaveAmplitude = baseWaveAmplitude + (formData.qrsDuration / 20) + (formData.qtcInterval / 100);
                currentWaveAmplitude = Math.min(hoverWaveAmplitude, currentWaveAmplitude);

                wavyCanvas.style.display = 'block';
                if (!animationFrameId) {
                    animate();
                }
                setupCanvasMouseListeners();
            }

            analyzeBtn.disabled = false;
            exportExcelBtn.disabled = false;
            analyzeBtn.textContent = 'Analyze ECG';
            spinner.remove();
        }

         function toggleNotOkRulesSection() {
             const notOkRulesListUl = document.getElementById('notOkRulesList');
             const toggleBtn = document.getElementById('toggleNotOkRulesBtn');

             if (notOkRulesListUl.style.display === 'none') {
                 notOkRulesListUl.style.display = 'block';
                 toggleBtn.textContent = 'Hide Rules Not Met';
             } else {
                 notOkRulesListUl.style.display = 'none';
                 toggleBtn.textContent = `Show Rules Not Met (${notOkRulesListUl.children.length})`;
             }
         }

         function toggleOkRulesSection() {
             const okRulesListContainerDiv = document.getElementById('okRulesListContainer');
             const toggleBtn = document.getElementById('toggleOkRulesBtn');

             if (okRulesListContainerDiv.style.display === 'none') {
                 okRulesListContainerDiv.style.display = 'block';
                 toggleBtn.textContent = 'Hide Rules Met';
             } else {
                 okRulesListContainerDiv.style.display = 'none';
                 toggleBtn.textContent = `Show Rules Met (${okRulesListContainerDiv.children.length})`;
             }
         }

         function toggleFirstInterpreterSection() { // Renamed
             const firstInterpretationList = document.getElementById('firstInterpretationList'); // Renamed
             const toggleBtn = document.getElementById('toggleFirstInterpreterBtn'); // Renamed

             if (firstInterpretationList.style.display === 'none') {
                 firstInterpretationList.style.display = 'block';
                 toggleBtn.textContent = 'Hide First Interpretations';
             } else {
                 firstInterpretationList.style.display = 'none';
                 toggleBtn.textContent = `Show First Interpretations (${firstInterpretationList.children.length})`;
             }
         }

         // New function for the empty Deep Interpreter block (for future LLM use)
         function toggleDeepInterpreterSection() {
             const deepInterpretationContent = document.getElementById('deepInterpretationContent');
             const toggleBtn = document.getElementById('toggleDeepInterpreterBtn'); // This button doesn't exist yet, but for consistency

             if (deepInterpretationContent.style.display === 'none') {
                 deepInterpretationContent.style.display = 'block';
                 toggleBtn.textContent = 'Hide Deep Interpretations';
             } else {
                 deepInterpretationContent.style.display = 'none';
                 toggleBtn.textContent = 'Show Deep Interpretations';
             }
         }


         function clearAnalysisResults() {
             document.getElementById('analysisSummary').innerHTML = '';
             document.getElementById('notOkRulesList').innerHTML = '';
             document.getElementById('notOkRulesSection').style.display = 'none';
             document.getElementById('toggleNotOkRulesBtn').style.display = 'none';
             document.getElementById('okRulesListContainer').innerHTML = '';
             document.getElementById('analysisResults').style.display = 'none';
             document.getElementById('toggleOkRulesBtn').style.display = 'none';
             document.getElementById('firstInterpretationList').innerHTML = ''; // Renamed
             document.getElementById('firstInterpreterSection').style.display = 'none'; // Renamed
             document.getElementById('toggleFirstInterpreterBtn').style.display = 'none'; // Renamed

             // Clear the new Deep Interpreter section
             document.getElementById('deepInterpretationContent').innerHTML = '<p>        ECG     .</p>';
             document.getElementById('deepInterpreterSection').style.display = 'none';


             const wavyCanvas = document.getElementById('wavyCanvas7');
             if (wavyCanvas) wavyCanvas.style.display = 'none';
             cancelAnimationFrame(animationFrameId);
             animationFrameId = null;
             currentCtx = null;
         }

        // Function for First Interpretation of ECG Findings (formerly Deep Interpretation)
        function firstInterpretECG(formData) {
            const firstInterpretationListUl = document.getElementById('firstInterpretationList');
            const firstInterpreterSection = document.getElementById('firstInterpreterSection');
            const toggleFirstInterpreterBtn = document.getElementById('toggleFirstInterpreterBtn');
            const firstInterpretationResults = [];

            // Define diagnostic categories and their prioritized rules
            const diagnosticCategories = [
                {
                    name: 'Atrial Abnormalities',
                    rules: [
                        {
                            check: (data) => data.rhythm === 'Atrial fibrillation' && data.pWaveShape === 'Absent',
                            message: '<strong>Atrial Fibrillation:</strong> Irregularly irregular rhythm with absent P waves. This is a primary diagnosis.'
                        },
                        {
                            check: (data) => data.rhythm === 'Atrial flutter' && data.pWaveShape === 'Sawtooth',
                            message: '<strong>Atrial Flutter:</strong> Typically a regular rhythm with sawtooth P waves. This is a primary diagnosis.'
                        },
                        {
                            check: (data) => data.atrialEnlargement === 'Right Atrial Enlargement',
                            message: '<strong>Right Atrial Enlargement (P pulmonale):</strong> Indicates strain on the right heart, possibly due to pulmonary embolism or COPD with right ventricular hypertrophy.'
                        },
                        {
                            check: (data) => data.atrialEnlargement === 'Left Atrial Enlargement',
                            message: '<strong>Left Atrial Enlargement (P mitrale):</strong> Suggests enlargement of the left atrium, often due to chronic hypertension or mitral valve disease.'
                        },
                        {
                            check: (data) => data.ectopicBeats && data.pWaveShape !== 'Normal' && data.pWaveShape !== 'Absent' && data.pWaveShape !== 'Sawtooth',
                            message: '<strong>Ectopic Atrial Rhythm / Premature Atrial Complexes (PAC):</strong> Presence of ectopic beats with abnormal P wave morphology, suggesting an atrial origin outside the SA node.'
                        },
                    ]
                },
                {
                    name: 'Pre-excitation Syndromes',
                    rules: [
                        {
                            check: (data) => isValidNumber(data.prInterval) && data.prInterval < 120 && data.qrsMorphology === 'Delta wave' && isValidNumber(data.qrsDuration) && data.qrsDuration > 100,
                            message: '<strong>Wolff-Parkinson-White (WPW) Syndrome:</strong> Characterized by short PR interval, delta wave, and wide QRS complex.'
                        },
                        {
                            check: (data) => isValidNumber(data.prInterval) && data.prInterval < 120 && data.qrsMorphology === 'Normal' && isValidNumber(data.qrsDuration) && data.qrsDuration <= 100,
                            message: '<strong>Lown-Ganong-Levine (LGL) Syndrome:</strong> Characterized by short PR interval and normal QRS duration, without a delta wave.'
                        },
                    ]
                },
                {
                    name: 'AV Blocks',
                    rules: [
                        {
                            check: (data) => data.avBlockType === '3rd Degree',
                            message: '<strong>Complete Heart Block (Third-Degree AV Block):</strong> P waves are unrelated to QRS complexes (AV dissociation) and bradycardia is present. This is a life-threatening urgency.'
                        },
                        {
                            check: (data) => data.avBlockType === 'Mobitz II',
                            message: '<strong>Second-Degree AV Block Mobitz II:</strong> Consistent PR interval with intermittent dropped QRS complexes. Requires close monitoring.'
                        },
                        {
                            check: (data) => data.avBlockType === 'Mobitz I (Wenckebach)',
                            message: '<strong>Second-Degree AV Block Mobitz I (Wenckebach):</strong> Progressive PR prolongation until a QRS complex is dropped. Often benign.'
                        },
                        {
                            check: (data) => isValidNumber(data.prInterval) && data.prInterval > 200 && data.avBlockType === 'None',
                            message: '<strong>First-Degree AV Block:</strong> PR interval is prolonged (>200 ms) without dropped beats.'
                        },
                    ]
                },
                {
                    name: 'Bundle Branch Blocks & Ventricular Rhythms',
                    rules: [
                        {
                            check: (data) => data.rhythm === 'Ventricular fibrillation',
                            message: '<strong>Ventricular Fibrillation (Cardiac Arrest):</strong> Chaotic ventricular activity, a medical emergency. Immediate intervention required.'
                        },
                        {
                            check: (data) => data.rhythm === 'Ventricular tachycardia',
                            message: '<strong>Ventricular Tachycardia:</strong> A rapid heart rhythm originating from the ventricles, often with wide QRS complexes. Potentially life-threatening.'
                        },
                        {
                            check: (data) => data.qrsMorphology === 'LBBB' && isValidNumber(data.qrsDuration) && data.qrsDuration > 120,
                            message: '<strong>Left Bundle Branch Block (LBBB):</strong> Wide QRS complex with characteristic LBBB morphology.'
                        },
                        {
                            check: (data) => data.qrsMorphology === 'RBBB' && isValidNumber(data.qrsDuration) && data.qrsDuration > 120,
                            message: '<strong>Right Bundle Branch Block (RBBB):</strong> Wide QRS complex with characteristic RBBB morphology.'
                        },
                        {
                            check: (data) => data.ectopicBeats && isValidNumber(data.qrsDuration) && data.qrsDuration > 120 && data.pWaveShape === 'Absent',
                            message: '<strong>Premature Ventricular Complexes (PVC):</strong> Indicated by wide, bizarre ectopic beats without preceding P waves.'
                        },
                        {
                            check: (data) => data.qrsMorphology === 'Notching/Slurring' && data.pathologicQWaves,
                            message: '<strong>Old MI / Conduction Block:</strong> Notching/slurring in QRS with pathologic Q waves suggests old myocardial infarction or intraventricular conduction delay.'
                        },
                        {
                            check: (data) => data.qrsMorphology === 'Normal' && data.qrsVoltage === 'Tall' && data.qrsAxis === 'Left Axis Deviation',
                            message: '<strong>Left Ventricular Hypertrophy (LVH):</strong> Suggested by increased QRS voltage and often left axis deviation.'
                        },
                        {
                            check: (data) => data.qrsMorphology === 'Normal' && data.qrsVoltage === 'Tall' && data.qrsAxis === 'Right Axis Deviation',
                            message: '<strong>Right Ventricular Hypertrophy (RVH):</strong> Suggested by increased QRS voltage and often right axis deviation.'
                        },
                    ]
                },
                {
                    name: 'QT Interval Abnormalities',
                    rules: [
                        {
                            check: (data) => data.qtAbnormality === 'Torsades de Pointes',
                            message: '<strong>Torsades de Pointes:</strong> Specific polymorphic ventricular tachycardia, strongly associated with prolonged QTc. Life-threatening.'
                        },
                        {
                            check: (data) => data.qtAbnormality === 'Prolonged' || (isValidNumber(data.qtcInterval) && data.qtcInterval > 440),
                            message: '<strong>Long QT Syndrome:</strong> Indicated by a prolonged QTc interval, increasing risk of arrhythmias.'
                        },
                        {
                            check: (data) => data.qtAbnormality === 'Shortened' || (isValidNumber(data.qtcInterval) && data.qtcInterval < 350),
                            message: '<strong>Short QT Syndrome / Hypercalcemia:</strong> Suggested by a shortened QTc interval, which can be due to hypercalcemia.'
                        },
                    ]
                },
                {
                    name: 'ST-T Wave Abnormalities & Ischemia/Infarction',
                    rules: [
                        {
                            check: (data) => data.stSegmentStatuses.includes('elevation') && data.tWaveAbnormalities === 'Hyperacute',
                            message: '<strong>Acute Myocardial Infarction (STEMI) - Evolving:</strong> Indicated by ST elevation and hyperacute T waves, suggesting early or evolving MI.'
                        },
                        {
                            check: (data) => data.stSegmentStatuses.includes('elevation') && data.pathologicQWaves,
                            message: '<strong>Acute Myocardial Infarction (STEMI) - Established:</strong> Indicated by ST elevation and pathologic Q waves, often with reciprocal changes.'
                        },
                        {
                            check: (data) => data.stSegmentStatuses.includes('depression') && data.tWaveAbnormalities === 'Inverted',
                            message: '<strong>Ischemia / NSTEMI / Unstable Angina:</strong> Suggested by ST depression and/or T wave inversion, without ST elevation, indicating myocardial ischemia.'
                        },
                        {
                            check: (data) => data.pathologicQWaves,
                            message: '<strong>Old Myocardial Infarction / Myocardial Scarring:</strong> Indicated by the presence of pathologic Q waves, suggesting prior myocardial necrosis.'
                        },
                        {
                            check: (data) => data.stSegmentStatuses.includes('earlyRepolarization'),
                            message: '<strong>Early Repolarization:</strong> J-point elevation and slurring, often a benign variant but can mask ischemia. Benign, or occult ischemia, must correlate clinically.'
                        },
                        {
                            check: (data) => data.stSegmentStatuses.includes('elevation') && !data.pathologicQWaves, // Generalizing diffuse ST elevation
                            message: '<strong>Pericarditis:</strong> Suggested by diffuse ST elevation, often without reciprocal depression or Q waves, and may be accompanied by PR depression.'
                        },
                        {
                            check: (data) => data.tWaveAbnormalities === 'Tall' && isValidNumber(data.qrsDuration) && data.qrsDuration > 100,
                            message: '<strong>Hyperkalemia / Hyperacute MI:</strong> Tall, peaked T waves can indicate hyperkalemia or very early (hyperacute) myocardial infarction.'
                        },
                    ]
                },
                {
                    name: 'Rhythm Disorders',
                    rules: [
                        {
                            check: (data) => data.rhythm === 'Sinus tachycardia',
                            message: '<strong>Sinus Tachycardia:</strong> Heart rate > 100 bpm with normal sinus rhythm, often due to physiological or pathological stress.'
                        },
                        {
                            check: (data) => data.rhythm === 'Sinus bradycardia',
                            message: '<strong>Sinus Bradycardia:</strong> Heart rate < 60 bpm with normal sinus rhythm.'
                        },
                        {
                            check: (data) => data.rhythm === 'Multifocal atrial rhythm', // Assuming this is an option
                            message: '<strong>Multifocal Atrial Rhythm:</strong> Often benign in elderly patients, characterized by at least three different P wave morphologies and irregular PP and PR intervals.'
                        },
                    ]
                },
                {
                    name: 'Other Conditions',
                    rules: [
                        {
                            check: (data) => data.qrsVoltage === 'Electrical alternans' && data.qrsVoltage === 'Low voltage',
                            message: '<strong>Cardiac Tamponade:</strong> Suggested by electrical alternans (alternating QRS amplitude) and low voltage QRS, indicating fluid around the heart.'
                        },
                        {
                            check: (data) => data.qrsVoltage === 'Low voltage' && data.qrsVoltage !== 'Electrical alternans',
                            message: '<strong>Pericardial Effusion / Amyloidosis / Obesity / COPD:</strong> Low voltage QRS can suggest these conditions due to increased impedance between the heart and ECG electrodes.'
                        },
                        {
                            check: (data) => data.rhythm === 'Sinus bradycardia' && data.osbornJWaves,
                            message: '<strong>Hypothermia:</strong> Suggested by sinus bradycardia and the presence of Osborn (J) waves.'
                        },
                        {
                            check: (data) => data.stSegmentStatuses.includes('elevation') && data.clinicalHistory.toLowerCase().includes('cns'), // Simplified for CNS events
                            message: '<strong>Acute CNS Events:</strong> Can cause ECG changes like diffuse T wave inversion or QT prolongation, mimicking cardiac ischemia.'
                        },
                    ]
                }
            ];

            // Iterate through categories and find the first matching rule
            diagnosticCategories.forEach(category => {
                for (const rule of category.rules) {
                    if (rule.check(formData)) {
                        firstInterpretationResults.push(rule.message);
                        break; // Stop after finding the first match in this category
                    }
                }
            });

            firstInterpretationListUl.innerHTML = '';
            if (firstInterpretationResults.length > 0) {
                firstInterpreterSection.style.display = 'block';
                toggleFirstInterpreterBtn.style.display = 'block';
                toggleFirstInterpreterBtn.textContent = `Hide First Interpretations (${firstInterpretationResults.length})`;
                firstInterpretationResults.forEach(interpretation => {
                    const li = document.createElement('li');
                    li.innerHTML = interpretation;
                    firstInterpretationListUl.appendChild(li);
                });
                firstInterpretationListUl.style.display = 'block';
            } else {
                firstInterpreterSection.style.display = 'none';
                toggleFirstInterpreterBtn.style.display = 'none';
            }
        }


        function exportToCSV() {
            const formData = {};
            document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(element => {
                const labelElement = element.previousElementSibling;
                let label = labelElement ? labelElement.textContent.replace(':', '').trim() : element.id;

                if (element.type === 'checkbox') {
                    label = element.parentElement.textContent.trim();
                    formData[label] = element.checked ? 'Yes' : 'No';
                } else if (element.type === 'radio') {
                    if (element.checked) {
                        const radioGroupLabel = document.querySelector(`label[for="${element.name}"]`) || { textContent: element.name };
                        formData[radioGroupLabel.textContent.replace(':', '').trim()] = element.value;
                    }
                } else if (element.tagName === 'SELECT') {
                    formData[label] = element.value;
                } else {
                    formData[label] = element.value;
                }
            });

            let csvContent = '';
            const headers = Object.keys(formData);
            const values = Object.values(formData);

            csvContent += headers.map(header => `"${header.replace(/"/g, '""')}"`).join(',') + '\n';
            csvContent += values.map(value => {
                if (typeof value === 'string') {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(',') + '\n';

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'ecg_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showModal('      CSV  .');
        }

        // Function to save form data to local storage
        function saveFormData() {
            const formData = {};
            document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(element => {
                if (element.type === 'checkbox') {
                    formData[element.id] = element.checked;
                } else if (element.type === 'radio') {
                     if (element.checked) {
                         formData[element.name] = element.value;
                     }
                }
                else {
                    formData[element.id] = element.value;
                }
            });
            localStorage.setItem('ecgFormData', JSON.stringify(formData));
        }

        // Function to load form data from local storage
        function loadFormData() {
            const savedData = localStorage.getItem('ecgFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                for (const key in formData) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = formData[key];
                             element.parentElement.classList.toggle('selected', element.checked);
                        } else if (element.type === 'radio') {
                             document.querySelectorAll(`input[name="${element.name}"]`).forEach(radio => {
                                 if (radio.value === formData[element.name]) {
                                     radio.checked = true;
                                     radio.parentElement.classList.add('selected');
                                 } else {
                                      radio.parentElement.classList.remove('selected');
                                 }
                             });
                        }
                        else {
                            element.value = formData[key];
                        }
                    }
                }
            }
        }

        function setupFormPersistence() {
            document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(element => {
                element.addEventListener('input', saveFormData);
                element.addEventListener('change', saveFormData);
            });
        }

        // Function to reset all form data and page statuses
        function resetForm() {
            // Clear all input fields
            document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(element => {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = false;
                    element.parentElement.classList.remove('selected');
                } else if (element.tagName === 'SELECT') {
                    element.value = ''; // Reset select to first option
                } else {
                    element.value = '';
                }
            });

            // Clear local storage
            localStorage.removeItem('ecgFormData');

            // Reset all page validation statuses to 'none'
            for (let i = 1; i <= totalPages; i++) {
                pageValidationStatus[i] = 'none';
            }

            // Clear all validation messages and highlights
            clearAllValidationMessages();

            // Clear analysis results and hide sections
            clearAnalysisResults();

            // Go to the first page
            currentPage = 1;
            showPage(currentPage);
            updatePaginationButtons();
            updateStepButtons();
            updateStepDropdown();
            updateOptionStates(); // Re-enable all options
        }


        // --- Animation Canvas Logic ---
        let baseWaveAmplitude = 10;
        const hoverWaveAmplitude = 50;
        let currentWaveAmplitude = baseWaveAmplitude;
        const waveFrequency = 0.1;
        let ecgSpeed = 6;
        let ecgOffset = 0;
        const ecgLineWidth = 5;

        const colors = [
            { r: 255, g: 0, b: 0 },
            { r: 255, g: 165, b: 0 },
            { r: 255, g: 255, b: 0 },
            { r: 0, g: 128, b: 0 },
            { r: 0, g: 0, b: 255 },
            { r: 75, g: 0, b: 130 },
            { r: 148, g: 0, b: 211 }
        ];
        let colorTransitionSpeed = 0.001;
        let currentColorTransitionSpeed = colorTransitionSpeed;
        const colorTransitionSpeedHover = 0.02;
        let colorPhase = 0;

        const circles = [];
        const maxCircleRadius = 20;
        const circleDecayRate = 3;
        const maxCircles = 100;

        let isMouseOverCanvas = false;
        let mouseX = -1;
        let mouseY = -1;
        let lastMouseX = -1;
        let lastMouseY = -1;


        function interpolateColor(colorA, colorB, factor) {
            const r = Math.round(colorA.r + factor * (colorB.r - colorA.r));
            const g = Math.round(colorA.g + factor * (colorB.g - colorA.g));
            const b = Math.round(colorA.b + factor * (colorB.b - colorA.b));
            return `rgb(${r},${g},${b})`;
        }

        function getECGY(x, centerLineY, scale) {
            const patternLength = 400;
            const normalizedX = (x + ecgOffset) % patternLength;

            if (normalizedX < 50) {
                return centerLineY;
            } else if (normalizedX < 70) {
                return centerLineY - Math.sin((normalizedX - 50) / 20 * Math.PI) * 10 * scale;
            } else if (normalizedX < 100) {
                return centerLineY;
            } else if (normalizedX < 110) {
                return centerLineY + (normalizedX - 100) * 3 * scale;
            } else if (normalizedX < 120) {
                return centerLineY - 30 * scale - (normalizedX - 110) * 5 * scale;
            } else if (normalizedX < 130) {
                return centerLineY + 20 * scale + (normalizedX - 120) * 5 * scale;
            } else if (normalizedX < 160) {
                return centerLineY;
            } else if (normalizedX < 200) {
                return centerLineY - Math.sin((normalizedX - 160) / 40 * Math.PI) * 15 * scale;
            } else {
                return centerLineY;
            }
        }


        function animate() {
             animationFrameId = requestAnimationFrame(animate);

             if (currentCanvas && currentCtx) {
                 currentCtx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);

                 ecgOffset = (ecgOffset + ecgSpeed);
                 if (ecgOffset >= 400) {
                     ecgOffset = ecgOffset % 400;
                 }

                 if (isMouseOverCanvas) {
                     currentColorTransitionSpeed = colorTransitionSpeedHover;
                 } else {
                     currentColorTransitionSpeed = colorTransitionSpeed;
                 }

                 colorPhase += currentColorTransitionSpeed;
                 if (colorPhase >= colors.length) {
                     colorPhase = 0;
                 }

                 const colorIndex1 = Math.floor(colorPhase);
                 const colorIndex2 = (colorIndex1 + 1) % colors.length;
                 const colorFactor = colorPhase - colorIndex1;

                 const currentColor1 = interpolateColor(colors[colorIndex1], colors[colorIndex2], colorFactor);
                 const nextColorForInterpolation = colors[(colorIndex2 + 1) % colors.length];
                 const currentColor2 = interpolateColor(colors[colorIndex2], nextColorForInterpolation, colorFactor);

                 const gradient = currentCtx.createLinearGradient(0, 0, currentCanvas.width, 0);
                 gradient.addColorStop(0, currentColor1);
                 gradient.addColorStop(1, currentColor2);

                 currentCtx.beginPath();
                 const centerLineY = currentCanvas.height / 2;
                 const scale = currentWaveAmplitude / baseWaveAmplitude;

                 currentCtx.moveTo(0, getECGY(0, centerLineY, scale));

                 for (let x = 1; x <= currentCanvas.width; x++) {
                     currentCtx.lineTo(x, getECGY(x, centerLineY, scale));
                 }

                 currentCtx.strokeStyle = gradient;
                 currentCtx.lineWidth = ecgLineWidth;
                 currentCtx.stroke();

                 if (isMouseOverCanvas && (mouseX !== lastMouseX || mouseY !== lastMouseY)) {
                     if (circles.length >= maxCircles) {
                         circles.shift();
                     }
                     circles.push({
                         x: mouseX,
                         y: mouseY,
                         initialRadius: maxCircleRadius,
                         initialColor: { r: 255, g: 0, b: 0 },
                         creationTime: Date.now()
                     });
                     lastMouseX = mouseX;
                     lastMouseY = mouseY;
                 }

                 for (let i = circles.length - 1; i >= 0; i--) {
                     const circle = circles[i];
                     const timeElapsed = Date.now() - circle.creationTime;
                     const currentRadius = Math.max(0, circle.initialRadius - timeElapsed * circleDecayRate / 100);

                     if (currentRadius > 0) {
                         const opacity = currentRadius / circle.initialRadius;
                         currentCtx.fillStyle = `rgba(255, 0, 0, ${opacity})`;
                         currentCtx.beginPath();
                         currentCtx.arc(circle.x, circle.y, currentRadius, 0, Math.PI * 2);
                         currentCtx.fill();
                         currentCtx.closePath();
                         circle.radius = currentRadius;
                     } else {
                         circles.splice(i, 1);
                     }
                 }
             }
        }

        function setupCanvasMouseListeners() {
             document.querySelectorAll('.wavy-canvas').forEach(canvasElement => {
                 canvasElement.removeEventListener('mousemove', handleCanvasMouseMove);
                 canvasElement.removeEventListener('mouseenter', handleCanvasMouseEnter);
                 canvasElement.removeEventListener('mouseleave', handleCanvasMouseLeave);
             });

             if (currentCanvas) {
                 currentCanvas.addEventListener('mousemove', handleCanvasMouseMove);
                 currentCanvas.addEventListener('mouseenter', handleCanvasMouseEnter);
                 currentCanvas.addEventListener('mouseleave', handleCanvasMouseLeave);
             }
        }

        function handleCanvasMouseMove(event) {
             const rect = currentCanvas.getBoundingClientRect();
             mouseX = event.clientX - rect.left;
             mouseY = event.clientY - rect.top;
        }

        function handleCanvasMouseEnter() {
             isMouseOverCanvas = true;
             currentWaveAmplitude = hoverWaveAmplitude;
             lastMouseX = mouseX;
             lastMouseY = mouseY;
        }

        function handleCanvasMouseLeave() {
             isMouseOverCanvas = false;
             currentWaveAmplitude = baseWaveAmplitude;
             mouseX = -1;
             mouseY = -1;
             lastMouseX = -1;
             lastMouseY = -1;
        }


        // Initialize the form
        window.onload = function() {
            // Reset all form data and page statuses on initial load
            resetForm();

            // Event listeners for select and checkbox elements (non-numeric, no range/flag divs)
            document.querySelectorAll('select.select-field, input[type="checkbox"], input[type="radio"]').forEach(element => {
                element.addEventListener('change', () => {
                    checkConflicts();
                    updateOptionStates();
                    validateCurrentPageAndSetStatus(); // Update status on change
                });
            });

            // Event listeners for patient info and clinical history (text/date, no range/flag divs)
            document.getElementById('patientId').addEventListener('input', () => {
                checkConflicts();
                updateOptionStates();
                validateCurrentPageAndSetStatus(); // Update status on change
            });
            document.getElementById('age').addEventListener('input', () => {
                checkConflicts();
                updateOptionStates();
                validateCurrentPageAndSetStatus(); // Update status on change
            });
            document.getElementById('recordingDate').addEventListener('change', () => {
                checkConflicts();
                updateOptionStates();
                validateCurrentPageAndSetStatus(); // Update status on change
            });
            document.getElementById('clinicalHistory').addEventListener('input', () => {
                checkConflicts();
                updateOptionStates();
                validateCurrentPageAndSetStatus(); // Update status on change
            });

            document.getElementById('toggleNotOkRulesBtn').addEventListener('click', toggleNotOkRulesSection);
            document.getElementById('toggleOkRulesBtn').addEventListener('click', toggleOkRulesSection);
            document.getElementById('toggleFirstInterpreterBtn').addEventListener('click', toggleFirstInterpreterSection); // Renamed listener
            // No listener for the new Deep Interpreter section yet, as it's for LLM

            const modal = document.getElementById('myModal');
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    hideModal();
                }
            });
        };

        window.addEventListener('resize', () => {
             if (currentCanvas) {
                 const container = currentCanvas.parentElement;
                 currentCanvas.width = container.clientWidth;
                 currentCanvas.height = 150;
             }
        });

    </script>
</body>
</html>
